<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Profiles ‚Äî Isaline (Glass Door)</title>
<style>
  /* micro animations for fav & play states */
  #favBtn { transition: transform 200ms ease, box-shadow 200ms ease, color 260ms ease; }
  #playBtn { transition: transform 160ms ease; }
  #playBtn:active { transform: scale(.98); }

@font-face {
  font-family: 'SwirlyCanalope';
  src: url('SwirlyCanalopePERSONALUSE-Regular.woff2') format('woff2'),
       url('SwirlyCanalopePERSONALUSE-Regular.woff') format('woff');
  font-display: swap;
}

/* ---------- variables & base ---------- */
:root{
  --bg-0:#07060a;
  --bg-1:#14121a;
  --card:#171821;
  --glass: rgba(255,255,255,0.06);
  --glass-2: rgba(255,255,255,0.09);
  --accent:#f7d6ff;
  --text:#f5f3ff;
  --soft:#b8b5d0;

  --max-width:480px;
  --page-padding: clamp(12px, 3.5vw, 20px);
  --card-radius: 16px;
  --tab-gap: 8px;
  --tab-min-width: 110px;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;}
body{
  display:flex;align-items:center;justify-content:center;
  background:radial-gradient(1200px 800px at 10% 10%, #1c1530 0%, #07060a 45%, #03020a 100%);
  color:var(--text);min-height:100vh;overflow:hidden;padding:20px;
}

/* container for app */
.shell{width:100%;max-width:var(--max-width);position:relative;z-index:10}

/* CONTENT (behind the glass door) */
.card{
  border-radius:18px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.03); box-shadow:0 18px 40px rgba(0,0,0,0.6);
  transform:translateY(0); transition:opacity .45s ease .35s, transform .45s ease .35s;
  opacity:0; pointer-events:auto;
  backdrop-filter: blur(2px);
}
.content-visible .card{ opacity:1; transform:none; }

/* ======= COMPACT HEADER (replaces old header) ======= */
.title-row.compact{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:10px; /* compact */
  padding-right:2px;
}
.title-left { display:flex; align-items:center; gap:12px; }
.compact-title{
  margin:0;
  font-size:16px;
  font-weight:700;
  letter-spacing: -0.01em;
}
/* subtitle removed to free space */
.subtitle { display:none !important; }

/* small icon close button */
.icon-btn{
  background:transparent;
  border:1px solid rgba(255,255,255,0.06);
  color:var(--soft);
  padding:6px 8px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  line-height:1;
}
.icon-btn:hover{ transform: translateY(-2px); transition: transform 120ms ease; box-shadow: 0 6px 16px rgba(0,0,0,0.12); }

/* ---------- TABS (responsive) ---------- */
.tabs{
  display:flex;
  gap:var(--tab-gap);
  margin-bottom:10px;
  align-items:center;
  position:relative;
}
.tab{
  min-width:var(--tab-min-width);
  flex:1;
  padding:8px 10px;
  border-radius:999px;
  font-size:13px;
  background:transparent;
  color:var(--soft);
  border:1px solid transparent;
  cursor:pointer;
  text-align:center;
  white-space:nowrap;
}
.tab.active{
  background:linear-gradient(180deg, rgba(247,214,255,0.06), rgba(247,214,255,0.03));
  border-color:rgba(247,214,255,0.12);
  color:var(--text);
}

/* small-screen: horizontal scroll with snap */
.tabs.tabs-scroll{
  overflow-x:auto;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x mandatory;
  padding-bottom:6px;
}
.tabs.tabs-scroll .tab{
  scroll-snap-align: start;
  flex:0 0 auto;
}

/* --- news button (small) positioned near tabs and pinned to top-right of card --- */
.news-btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:8px;
  border-radius:10px;
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
  cursor:pointer;
  color:var(--soft);
  font-size:12px;
  position:absolute;
  right:0;
  top:0;
  transform:translate(12px,-8px);
  z-index:6;
  backdrop-filter: blur(4px);
}
.news-btn:hover { transform:translate(12px,-8px) translateY(-3px); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

/* small circular logo inside */
.news-logo {
  width:18px;height:18px;border-radius:6px;display:inline-block;background:linear-gradient(180deg,#ffd6ea,#ffdfff);font-weight:700;color:#130f1a;text-align:center;line-height:18px;font-size:12px;
}

/* large screen: distribute evenly using grid */
@media (min-width:640px){
  .tabs{
    display:grid;
    grid-auto-flow:column;
    grid-auto-columns:1fr;
    gap:10px;
  }
  .tabs .tab{
    min-width:0;
    flex:1 1 auto;
  }
  .card{ padding:22px; }
}

/* card/profile styles */
.profile{
  border-radius:14px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(9,9,18,0.95));
  border:1px solid rgba(255,255,255,0.02);margin-bottom:14px;
  position:relative;
  overflow:hidden;
}
.profile h2{margin:0 0 2px;font-size:15px;font-weight:600}
.profile small{display:block;font-size:11px;color:var(--soft);margin-bottom:8px}
.profile p {
  font-family: 'SwirlyCanalope', serif;
  font-size: 18px;
  color: #eedeff;
  line-height: 1.6;
  margin:0;
}

/* ---------- SPARKLE (interactive) ---------- */
.sparkle-pop {
  position: absolute;
  width: 6px;
  height: 6px;
  pointer-events: none;
  border-radius: 50%;
  background: radial-gradient(circle, #ffffff 0%, #e7d4ff 60%, transparent 100%);
  opacity: 0;
  animation: sparkleFade 1.2s ease-out forwards;
  filter: blur(0.4px);
  transform-origin: center;
}
@keyframes sparkleFade {
  0% { transform: translateY(0) scale(0.5); opacity: 0; }
  15% { transform: translateY(-4px) scale(1); opacity: 0.95; }
  50% { transform: translateY(-12px) scale(1.15); opacity: 0.8; }
  100% { transform: translateY(-22px) scale(0.7); opacity: 0; }
}

/* buttons */
.btn-row{display:flex;gap:8px}
button.primary, button.ghost{flex:1;border-radius:999px;padding:10px 16px;font-size:13px;font-weight:600;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
button.primary{background:#f5f0ff;color:#161622}
button.ghost{background:transparent;color:var(--soft);border:1px solid rgba(255,255,255,0.06)}

/* fox default (make fav and play look identical initially) */
#favBtn {
  color: var(--soft);
  background: #f5f0ff;
  color: #161622;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  padding-left: 18px;
  padding-right: 18px;
}
#playBtn {
  background: #f5f0ff;
  color: #161622;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  padding-left: 18px;
  padding-right: 18px;
}
#favBtn:hover, #playBtn:hover { transform: translateY(-2px); transition: transform 120ms ease; }

/* fav active: color, background, glow & wiggle */
#favBtn.fav-active {
  color: #161622;
  background: linear-gradient(180deg, #fceeff, #f7d6ff);
  text-shadow: 0 0 6px rgba(255,180,255,0.45), 0 0 12px rgba(255,150,255,0.12);
  box-shadow: 0 10px 26px rgba(180,120,255,0.14);
  animation: foxWiggle 0.45s ease-out;
  transform-origin: center center;
}

/* play playing state (pulsing) */
#playBtn.playing {
  background: linear-gradient(180deg, #fff2fb, #f4caff);
  color: #161622;
  box-shadow: 0 10px 26px rgba(160,110,240,0.12);
  animation: pulsePlay 1.4s ease-in-out infinite;
}

/* subtle pressed state */
#favBtn:active, #playBtn:active { transform: scale(0.99); transition: transform 80ms ease; }

.helper{margin-top:10px;font-size:10px;color:#8581a1;text-align:center}

/* GLASS DOOR overlay */
.door-overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;pointer-events:auto}
.door-wrap{width:100%;max-width:900px;height:100vh;display:flex;perspective:1400px}
.leaf{
  flex:1;height:100vh;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;
  border:1px solid rgba(255,255,255,0.06);

  background:
    linear-gradient(180deg, rgba(180,140,255,0.10), rgba(120,90,180,0.12)),
    linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));

  box-shadow:
    inset 0 1px 0 rgba(255,255,255,0.08),
    0 30px 80px rgba(60,0,120,0.45);

  transform-origin:left center;transform-style:preserve-3d;
  backdrop-filter: blur(7px) saturate(1.15);
}
.leaf.right{transform-origin:right center}
.leaf::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(120deg,
    rgba(200,160,255,0.05),
    rgba(240,200,255,0.12) 20%,
    rgba(150,120,220,0.06) 55%,
    transparent 85%
  );
  mix-blend-mode:screen;
  pointer-events:none;
  transform:translateZ(40px);
}
.leaf::after{
  content:"";position:absolute;left:18%;right:18%;top:40%;height:2px;border-radius:50px;
  background:linear-gradient(90deg, rgba(160,120,255,0.18), rgba(245,215,255,0.22));
  opacity:1;
}
.leaf .label{position:relative;color:var(--soft);font-size:14px;letter-spacing:0.04em}

/* open animations */
@keyframes open-left {
  0%{ transform: rotateY(0deg) translateZ(0) }
  100%{ transform: rotateY(-88deg) translateZ(-60px) translateX(-20%); opacity:0 }
}
@keyframes open-right {
  0%{ transform: rotateY(0deg) translateZ(0) }
  100%{ transform: rotateY(88deg) translateZ(-60px) translateX(20%); opacity:0 }
}

/* play pulse */
@keyframes pulsePlay {
  0% { transform: scale(1); box-shadow: 0 0 0 rgba(255,200,255,0.0); }
  50% { transform: scale(1.03); box-shadow: 0 0 12px rgba(255,200,255,0.12); }
  100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,200,255,0.0); }
}

/* set duration to 1.6s for cinematic ~2s experience */
.door-opening .leaf.left{ animation: open-left 1.6s cubic-bezier(.2,.9,.2,1) forwards; }
.door-opening .leaf.right{ animation: open-right 1.6s cubic-bezier(.2,.9,.2,1) forwards; }

/* remove overlay after finished */
.hidden-overlay{ display:none !important; }

/* replay button */
.replay {
  position:fixed; right:18px; bottom:18px; z-index:10010;
  background:rgba(255,255,255,0.04); color:var(--soft); border:1px solid rgba(255,255,255,0.03);
  padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer;
}

@media (max-width:480px){
  .leaf::after{left:12%;right:12%}
  :root{ --tab-min-width:92px; }
}

/* accessibility focus */
.tab:focus { outline: 3px solid rgba(247,214,255,0.12); outline-offset:3px; }
button:focus { outline: 3px solid rgba(247,214,255,0.12); outline-offset:3px; }

/* ---------- FOX WIGGLE ANIMATION ---------- */
@keyframes foxWiggle {
  0%   { transform: rotate(0deg) scale(1); }
  25%  { transform: rotate(-6deg) scale(1.08); }
  50%  { transform: rotate(4deg) scale(1.06); }
  75%  { transform: rotate(-3deg) scale(1.05); }
  100% { transform: rotate(0deg) scale(1.06); }
}

/* ---------- SIMPLE HEADER Auroreine ---------- */
/* centered header "Auroreine" */
.title-row.compact.simple-one {
  padding: 8px 0 14px;
  display: flex;
  justify-content: center;     /* ‚¨ÖÔ∏è bikin tulisan di tengah */
  align-items: center;
  width: 100%;
  text-align: center;
}

.compact-title.simple-name {
  margin: 0;
  font-size: 17px;
  font-weight: 700;
  letter-spacing: 0.03em;
  color: var(--text);
}
.compact-title.simple-name {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.02em;
  color: var(--text);
}

/* close button mini style */
.icon-btn {
  padding: 6px 8px;
  font-size: 13px;
  opacity: 0.95;
}
  
/* ---------- GIF / ICON styles ---------- */
/* fav icon image inside button */
#favIcon{
  width:18px;height:18px;object-fit:contain;border-radius:6px;display:inline-block;vertical-align:middle;
}
#favBtn .label-text{display:inline-block;vertical-align:middle;margin-left:8px}

/* small fade-in for gif when it appears */
.fav-gif-in{
  animation: favGifIn 260ms ease both;
}
@keyframes favGifIn{
  from{ opacity:0; transform: scale(0.92) }
  to{ opacity:1; transform: scale(1) }
}

/* ---------- NEWS MODAL / LIST ---------- */
.news-modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(5,4,8,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10020;
}
.news-modal-backdrop.open { display:flex; }

.news-modal {
  width: min(720px, calc(100% - 40px));
  max-height: 80vh;
  background: linear-gradient(180deg, rgba(12,10,14,0.96), rgba(16,14,20,0.98));
  border-radius: 14px;
  padding: 14px;
  overflow: auto;
  border: 1px solid rgba(255,255,255,0.04);
  box-shadow: 0 30px 80px rgba(0,0,0,0.6);
  color:var(--text);
}
.news-header {
  display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px;
}
.news-list { display:flex; flex-direction:column; gap:10px; }
.news-item {
  display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));
  border:1px solid rgba(255,255,255,0.02);
}
.news-thumb { width:74px; height:74px; border-radius:10px; background:#111; flex-shrink:0; object-fit:cover; }
.news-meta { flex:1; min-width:0; }
.news-title { font-weight:700; font-size:13px; margin:0 0 4px 0; color:var(--text) }
.news-excerpt { font-size:13px; color:var(--soft); line-height:1.4; margin:0; white-space:normal; overflow:hidden; text-overflow:ellipsis; max-height:3.2em; }
.news-actions { display:flex; gap:8px; margin-top:8px; }
.news-fallback-iframe { width:100%; height:60vh; border-radius:10px; border:1px solid rgba(255,255,255,0.04); }

/* small "no posts" */
.news-empty { text-align:center; color:var(--soft); padding:26px 10px; }

/* accessibility focus */
.news-close { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--soft); padding:8px 10px; border-radius:8px; cursor:pointer; }
.news-open-tele { background:#f5f0ff; color:#161622; border-radius:8px; padding:8px 10px; font-weight:700; cursor:pointer; border:none; }

/* narrow screens */
@media (max-width:520px) {
  .news-item { flex-direction:row; }
  .news-thumb { width:58px; height:58px; }
}
</style>
</head>
<body>
  <!-- door overlay -->
  <div class="door-overlay" id="doorOverlay" aria-hidden="true">
    <div class="door-wrap" id="doorWrap">
      <div class="leaf left"><div class="label">‚Äî S15 ‚Äî</div></div>
      <div class="leaf right"><div class="label">‚Äî atelier ‚Äî</div></div>
    </div>
  </div>

  <!-- main content -->
  <div class="shell" id="shell">
    <div class="card" id="card">

  <!-- --------- SIMPLE ONE-LINE HEADER: "Auroreine" --------- -->
<!-- Simple centered header -->
<div class="title-row compact simple-one" role="banner">
  <h1 class="compact-title simple-name">Auroreine</h1>
</div>


      <!-- tabs -->
      <div class="tabs" id="tabs">
        <button class="tab active" id="tab-zhou">‚ú¶ Muse</button>
        <button class="tab" id="tab-rp">‚úß Another Universe</button>

        <!-- NEWS button sits visually near tabs and pinned to top-right -->
        <button id="tab-news" class="news-btn" title="Latest news from channel">
          <span class="news-logo" aria-hidden="true">üóûÔ∏è</span>
          <!-- visually small label for screen readers only -->
          <span style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;">News</span>
        </button>
      </div>

      <div class="profile" id="profile">
        <h2 id="profile-title">Zhou Xinyu</h2>
        <small id="profile-tag">Muse ¬∑ TripleS</small>
        <p id="profile-text">Soft-spoken, stage-light kind of pretty.
Carries winter glow and slow-day calm,
like a quiet verse written in silver.</p>
      </div>

      <div class="btn-row">
        <!-- favorite now holds an <img> for the fox which we toggle between static/animated -->
        <button class="primary" id="favBtn" aria-pressed="false" title="Favorite">
          <img id="favIcon" alt="fox icon" src="foxfixfix.gif" aria-hidden="true">
          <span class="label-text">Favorite</span>
        </button>
        <button class="ghost" id="playBtn" aria-pressed="false" title="Play preview">‚ñ∂ Play</button>
      </div>

      <!-- profile audio (preview) -->
      <!-- DEFAULT source set to playsongnew.mp3 as requested -->
      <audio id="profileAudio" preload="auto">
        <source src="playsongnew.mp3" type="audio/mpeg">
      </audio>

      <div class="helper">Your choice will be sent back to the bot as a tiny note.</div>
    </div>
  </div>

  <!-- optional audio: door_open.mp3 (place in same folder if you want sound) -->
  <audio id="doorAudio" preload="auto">
    <source src="door_open.mp3" type="audio/mpeg">
  </audio>

  <button class="replay" id="replayBtn" title="Replay door effect">Replay ‚ú®</button>

  <!-- NEWS modal markup (hidden by default) -->
  <div class="news-modal-backdrop" id="newsBackdrop" aria-hidden="true">
    <div class="news-modal" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
      <div class="news-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:36px;height:36px;border-radius:9px;background:linear-gradient(180deg,#ffd6ea,#ffdfff);display:flex;align-items:center;justify-content:center;font-weight:700;color:#130f1a;">üóûÔ∏è</div>
          <div>
            <div id="newsTitle" style="font-weight:800;font-size:16px;">Latest ‚Äî S15XINYU</div>
            <div style="font-size:12px;color:var(--soft);">Newest at top ¬∑ updates automatically</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="news-close" id="newsClose">Close</button>
          <a class="news-open-tele" id="newsOpenChannel" target="_blank" rel="noopener noreferrer" href="https://t.me/S15XINYU">Open in Telegram</a>
        </div>
      </div>

      <div id="newsContent">
        <div class="news-empty" id="newsLoading">Loading latest posts‚Ä¶</div>
      </div>
    </div>
  </div>

<script>
  // Telegram WebApp
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  if (tg) try { tg.expand(); tg.ready(); } catch(e){}

  const doorOverlay = document.getElementById('doorOverlay');
  const doorWrap = document.getElementById('doorWrap');
  const shell = document.getElementById('shell');
  const card = document.getElementById('card');
  const doorAudio = document.getElementById('doorAudio');
  const replayBtn = document.getElementById('replayBtn');

  // profile data
  const profiles = {
    zhou: {
      title: "Zhou Xinyu",
      tag: "Muse ¬∑ TripleS",
      text: "Soft-spoken, stage-light kind of pretty.\nCarries winter glow and slow-day calm,\nlike a quiet verse written in silver."
    },
    rp: {
      title: "Meredith Melrose",
      tag: "S15 ¬∑ night-coded",
      text: "Writes in lowercase and starlight.\nHalf diary, half song, always a little\nlate to leave the dream."
    }
  };
  let selected = 'zhou';

  // dom refs
  const tZ = document.getElementById('tab-zhou');
  const tR = document.getElementById('tab-rp');
  const tNews = document.getElementById('tab-news');
  const tabsRoot = document.getElementById('tabs');

  // SPARKLE
  function makeSparkle(x, y, size = null) {
    const profileBox = document.getElementById("profile");
    if (!profileBox) return;
    const sp = document.createElement("div");
    sp.className = "sparkle-pop";
    const s = size || (6 + Math.floor(Math.random()*8));
    sp.style.width = s + "px";
    sp.style.height = s + "px";
    sp.style.left = Math.round(x) + "px";
    sp.style.top = Math.round(y) + "px";
    sp.style.transform = `translateY(0) scale(${0.6 + Math.random()*0.9})`;
    profileBox.appendChild(sp);
    setTimeout(() => { if (sp && sp.parentNode) sp.parentNode.removeChild(sp); }, 1400);
  }

  function burstSparkles(count = 5) {
    const box = document.getElementById("profile");
    if (!box) return;
    const rect = box.getBoundingClientRect();
    for (let i = 0; i < count; i++) {
      const delay = Math.random() * 180;
      setTimeout(() => {
        const paddingX = Math.max(8, rect.width * 0.06);
        const paddingY = Math.max(8, rect.height * 0.06);
        const x = Math.random() * (rect.width - paddingX*2) + paddingX;
        const y = Math.random() * (rect.height - paddingY*2) + paddingY;
        makeSparkle(x, y);
      }, delay);
    }
  }

  // FAVORITE & PLAY elements
  const favBtn = document.getElementById('favBtn');
  const playBtn = document.getElementById('playBtn');
  const profileAudio = document.getElementById('profileAudio') || null;
  const favIcon = document.getElementById('favIcon');

  // map per-profile audio filenames (both point to playsongnew.mp3 by default)
  const PROFILE_AUDIO_MAP = {
    zhou: 'playsongnew.mp3',
    rp: 'playsongnew.mp3'
  };
  function currentProfileAudioFile() {
    return PROFILE_AUDIO_MAP[selected] || 'playsongnew.mp3';
  }

  // Preload fox images (gif + optional static fallback)
  const FOX_GIF = 'foxfixfix.gif';
  const FOX_PNG = 'foxfixfix.gif'; // fallback tetap sama file atau bisa ganti ke png kalau ada
  const _preloads = [];
  function preload(src){ try{ const i=new Image(); i.src=src; _preloads.push(i); }catch(e){} }
  preload(FOX_GIF); preload(FOX_PNG);

  // FAVORITE logic (localStorage)
  const STORAGE_KEY = 'miniapp_favs_v1';
  function loadFavs() {
    try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {}; }
    catch(e){ return {}; }
  }
  function saveFavs(obj) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){}
  }

  function setFavState(isFav) {
    favBtn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
    // update text
    const label = favBtn.querySelector('.label-text');
    if (label) label.textContent = isFav ? 'Favorited' : 'Favorite';

    // always use foxfoxie.gif for icon (both normal & favorited)
    try {
      favIcon.src = FOX_GIF;

      if (isFav) {
        favIcon.classList.add('fav-gif-in');
        favBtn.classList.add('fav-active');
        burstSparkles(5);
      } else {
        favIcon.classList.remove('fav-gif-in');
        favBtn.classList.remove('fav-active');
      }
    } catch(e){
      // degrade: remove image and fallback to text
      if (favIcon && favIcon.parentNode) favIcon.parentNode.removeChild(favIcon);
      if (label) label.textContent = isFav ? 'Favorited' : 'Favorite';
    }
  }

  // handle missing PNG fallback: if image errors, hide it and fall back to emoji label
  favIcon.addEventListener('error', (ev)=>{
    // hide image, fall back to text only
    favIcon.style.display = 'none';
    const label = favBtn.querySelector('.label-text');
    if (label) label.style.marginLeft = '0';
  });
  favIcon.addEventListener('load', ()=>{ favIcon.style.display = 'inline-block'; });

  favBtn.addEventListener('click', () => {
    const favs = loadFavs();
    const currently = !!favs[selected];
    if (currently) delete favs[selected];
    else favs[selected] = { ts: Date.now() };
    saveFavs(favs);
    setFavState(!currently);

    // send a tiny note back to Telegram bot (if available)
    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.sendData) {
      try { window.Telegram.WebApp.sendData(JSON.stringify({ type: 'fav', profile: selected, fav: !currently })); } catch(e){}
    }
  });

  // update fav UI for current selected - only called on load/init, NOT on tab change
  function initFavUIForCurrent() {
    const favs = loadFavs();
    const isFav = !!favs[selected];
    // ensure favIcon has a sensible default src before calling setFavState
    favIcon.src = FOX_GIF;
    setFavState(isFav);
  }

  /* PLAY audio logic ‚Äî toggles play / pause and uses playsongnew.mp3 */
  playBtn.addEventListener('click', async () => {
    if (!profileAudio) {
      alert('Audio not available. Tambahkan playsongnew.mp3 di folder yang sama dengan file ini.');
      return;
    }

    // set source sesuai profile (lazily) ‚Äî PROFILE_AUDIO_MAP maps to playsongnew.mp3
    const desired = currentProfileAudioFile();
    const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || '';
    if (currentSource !== desired) {
      profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`;
      try { profileAudio.load(); } catch(e){}
    }

    // toggle play/pause (user gesture required for play())
    try {
      if (profileAudio.paused) {
        await profileAudio.play();
        playBtn.classList.add('playing');
        playBtn.textContent = '‚è∏ Pause';
        playBtn.setAttribute('aria-pressed','true');
      } else {
        profileAudio.pause();
        playBtn.classList.remove('playing');
        playBtn.textContent = '‚ñ∂ Play';
        playBtn.setAttribute('aria-pressed','false');
      }
    } catch (err) {
      playBtn.classList.remove('playing');
      playBtn.textContent = '‚ñ∂ Play';
      playBtn.setAttribute('aria-pressed','false');
      console.warn('Audio play error', err);
      alert('Gagal memutar audio ‚Äî coba tekan lagi atau periksa file audio (playsongnew.mp3).');
    }
  });

  // Keep UI in sync when audio state changes
  if (profileAudio) {
    profileAudio.addEventListener('play', () => {
      playBtn.classList.add('playing');
      playBtn.textContent = '‚è∏ Pause';
      playBtn.setAttribute('aria-pressed','true');
    });

    profileAudio.addEventListener('pause', () => {
      playBtn.classList.remove('playing');
      playBtn.textContent = '‚ñ∂ Play';
      playBtn.setAttribute('aria-pressed','false');
    });

    profileAudio.addEventListener('ended', () => {
      playBtn.classList.remove('playing');
      playBtn.textContent = '‚ñ∂ Play';
      playBtn.setAttribute('aria-pressed','false');
      try { profileAudio.currentTime = 0; } catch(e){}
    });
  }

  // ---------- UPDATED setActive (preserve audio play state when switching) ----------
  function setActive(k){
    // update selected & DOM
    selected = k;
    const d = profiles[k];
    document.getElementById('profile-title').textContent = d.title;
    document.getElementById('profile-tag').textContent = d.tag;
    document.getElementById('profile-text').textContent = d.text;
    if(k==='zhou'){ tZ.classList.add('active'); tR.classList.remove('active'); } else { tR.classList.add('active'); tZ.classList.remove('active'); }

    // --- handle audio source switching without interrupting play state ---
    if (!profileAudio) return;

    try {
      const desired = currentProfileAudioFile(); // filename for selected
      const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || '';

      // if source is already the same, do nothing (keeps current play/pause/time)
      if (currentSource === desired) return;

      // remember playing state and time
      const wasPlaying = !profileAudio.paused && !profileAudio.ended;
      const currentTime = Math.max(0, Math.min(profileAudio.currentTime || 0, 999999));

      // create new source element (lazy swap)
      profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`;
      try { profileAudio.load(); } catch (e) { /* ignore load errors */ }

      // try to restore time and resume if it was playing
      // note: some browsers disallow setting currentTime until metadata is loaded,
      // so we try best-effort and then attempt again on 'loadedmetadata'
      function tryRestore() {
        try {
          // clamp time to duration (if available)
          if (profileAudio.duration && !isNaN(profileAudio.duration)) {
            const t = Math.min(currentTime, Math.max(0, profileAudio.duration - 0.01));
            profileAudio.currentTime = t;
          } else {
            profileAudio.currentTime = currentTime;
          }
        } catch (err) { /* ignore */ }
        if (wasPlaying) {
          profileAudio.play().catch(()=>{ /* autoplay policy may block until user gesture; ignore */ });
        }
        // cleanup listener (one-time)
        profileAudio.removeEventListener('loadedmetadata', tryRestore);
      }

      // if metadata already loaded, try immediately, else wait
      if (profileAudio.readyState >= 1) {
        tryRestore();
      } else {
        profileAudio.addEventListener('loadedmetadata', tryRestore);
      }

    } catch (err) {
      console.warn('Error while switching profile audio (non-fatal):', err);
    }
  }

  // attach tab listeners now
  tZ.addEventListener('click', ()=> { setActive('zhou'); burstSparkles(6); });
  tR.addEventListener('click', ()=> { setActive('rp'); burstSparkles(6); });

  // init states on load
  window.addEventListener('load', ()=> {
    initFavUIForCurrent();
  });

  // door sequence timings adjusted to ~2s cinematic:
  function openDoor(playSound=true){
    setTimeout(()=> shell.classList.add('content-visible'), 1200);
    if(playSound && doorAudio && doorAudio.src){
      doorAudio.currentTime = 0;
      doorAudio.play().catch(()=>{});
    }
    doorWrap.classList.add('door-opening');
    setTimeout(()=> {
      doorOverlay.classList.add('hidden-overlay');
      shell.classList.add('content-visible');
    }, 1600);
  }
  setTimeout(()=> openDoor(true), 260);

  // replay support
  replayBtn.addEventListener('click', ()=> {
    doorOverlay.classList.remove('hidden-overlay');
    doorWrap.classList.remove('door-opening');
    shell.classList.remove('content-visible');
    void doorWrap.offsetWidth;
    setTimeout(()=> openDoor(true), 80);
  });

  // responsive tabs helper
  (function(){
    function updateTabsMode() {
      if(!tabsRoot) return;
      if(window.matchMedia('(max-width: 639px)').matches) {
        tabsRoot.classList.add('tabs-scroll');
      } else {
        tabsRoot.classList.remove('tabs-scroll');
      }
    }
    updateTabsMode();
    window.addEventListener('resize', updateTabsMode);
    window.addEventListener('orientationchange', updateTabsMode);
  })();

  /**************************************************************************
   * NEWS modal logic
   *
   * Behavior:
   *  - Try to fetch https://t.me/s/S15XINYU (public channel "view as web")
   *  - If fetch succeeds and we can parse HTML, extract up to N latest posts
   *    (thumbnail + excerpt + link)
   *  - If fetch fails (likely due to CORS), show fallback iframe to https://t.me/s/S15XINYU
   *
   * Note: Because of browser CORS restrictions, direct fetch may be blocked.
   **************************************************************************/

  const NEWS_CHANNEL = 'S15XINYU'; // channel short name (no @, no leading slash)
  const NEWS_S_URL = `https://t.me/s/${NEWS_CHANNEL}`;
  const newsBackdrop = document.getElementById('newsBackdrop');
  const newsContent = document.getElementById('newsContent');
  const newsLoading = document.getElementById('newsLoading');
  const newsClose = document.getElementById('newsClose');
  const newsOpenChannel = document.getElementById('newsOpenChannel');

  // helper: safe truncate
  function truncateText(s, n = 140) {
    if (!s) return '';
    s = s.replace(/\s+/g, ' ').trim();
    if (s.length <= n) return s;
    return s.slice(0, n-1).trim() + '‚Ä¶';
  }

  // build news list markup from parsed posts array
  function renderNewsList(posts) {
    if (!posts || posts.length === 0) {
      newsContent.innerHTML = '<div class="news-empty">No recent posts were found.</div>';
      return;
    }
    const list = document.createElement('div');
    list.className = 'news-list';
    posts.forEach(post => {
      const item = document.createElement('div');
      item.className = 'news-item';

      const thumb = document.createElement('img');
      thumb.className = 'news-thumb';
      thumb.alt = 'thumb';
      thumb.loading = 'lazy';
      if (post.thumb) thumb.src = post.thumb;
      else thumb.style.background = '#111'; // empty placeholder

      const meta = document.createElement('div');
      meta.className = 'news-meta';

      const title = document.createElement('div');
      title.className = 'news-title';
      // use timestamp short or channel name
      title.textContent = post.timeStr || `S15XINYU`;

      const excerpt = document.createElement('p');
      excerpt.className = 'news-excerpt';
      excerpt.textContent = truncateText(post.excerpt || post.text || '', 140);

      const actions = document.createElement('div');
      actions.className = 'news-actions';
      const btnOpen = document.createElement('a');
      btnOpen.className = 'news-open-tele';
      btnOpen.textContent = 'Open in Telegram';
      btnOpen.href = post.link || NEWS_S_URL;
      btnOpen.target = '_blank';
      btnOpen.rel = 'noopener noreferrer';

      actions.appendChild(btnOpen);
      meta.appendChild(title);
      meta.appendChild(excerpt);
      meta.appendChild(actions);

      item.appendChild(thumb);
      item.appendChild(meta);
      list.appendChild(item);
    });

    newsContent.innerHTML = '';
    newsContent.appendChild(list);
  }

  // fallback to iframe view (when CORS blocks fetch or parsing fails)
  function renderFallbackIframe() {
    newsContent.innerHTML = '';
    const iframe = document.createElement('iframe');
    iframe.className = 'news-fallback-iframe';
    iframe.src = NEWS_S_URL;
    iframe.setAttribute('loading','lazy');
    iframe.setAttribute('referrerpolicy','no-referrer');
    newsContent.appendChild(iframe);
  }

  // attempt to fetch and parse t.me/s pages
  async function loadNewsParsed(maxPosts = 6) {
    // show loading
    newsContent.innerHTML = '<div class="news-empty">Loading latest posts‚Ä¶</div>';

    try {
      const res = await fetch(NEWS_S_URL, { method: 'GET', mode: 'cors' });
      if (!res.ok) throw new Error('Network response not ok: ' + res.status);
      const text = await res.text();
      // parse HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, 'text/html');

      // Try to find message containers (Telegram web uses several classes)
      // We search for elements that look like messages: ".tgme_widget_message"
      const msgs = Array.from(doc.querySelectorAll('.tgme_widget_message, .tgme_widget_message_wrap, .tme_widget_message'));
      if (!msgs || msgs.length === 0) {
        // Try another heuristic: find article/message text blocks
        const alt = Array.from(doc.querySelectorAll('.tgme_widget_message_text, .tgme_widget_message_text, .message'));
        if (!alt || alt.length === 0) throw new Error('No message nodes found');
      }

      // Build posts array
      const posts = [];
      for (let i = 0; i < msgs.length && posts.length < maxPosts; i++) {
        const m = msgs[i];
        // excerpt: text content from .tgme_widget_message_text or any text inside
        const textNode = m.querySelector('.tgme_widget_message_text') || m.querySelector('.message_text') || m.querySelector('p') || m;
        let excerpt = '';
        if (textNode) excerpt = textNode.textContent || textNode.innerText || '';
        // thumbnail: look for img inside .tgme_widget_message_photo or style background-image
        let thumb = null;
        const photo = m.querySelector('.tgme_widget_message_photo') || m.querySelector('.tgme_widget_message_photo_wrap') || m.querySelector('img');
        if (photo) {
          // try data-src or src or style background-image
          const img = photo.querySelector ? photo.querySelector('img') : null;
          if (img && (img.getAttribute('src') || img.getAttribute('data-src'))) {
            thumb = img.getAttribute('src') || img.getAttribute('data-src');
          } else if (photo.style && photo.style.backgroundImage) {
            const bg = photo.style.backgroundImage;
            const match = bg.match(/url\(["']?(.*?)["']?\)/);
            if (match) thumb = match[1];
          } else if (photo.getAttribute && (photo.getAttribute('src') || photo.getAttribute('data-src'))) {
            thumb = photo.getAttribute('src') || photo.getAttribute('data-src');
          }
        }
        // link: check for anchor linking to post
        let link = null;
        const a = m.querySelector('a.tgme_widget_message_date') || m.querySelector('a[href*="/' + NEWS_CHANNEL + '/"]') || m.querySelector('a');
        if (a && a.href) link = a.href;
        // time string
        let timeStr = '';
        const timeNode = m.querySelector('.tgme_widget_message_date') || m.querySelector('time');
        if (timeNode) timeStr = timeNode.textContent || timeNode.getAttribute('datetime') || '';

        posts.push({ excerpt: excerpt.trim(), thumb, link, timeStr });
      }

      if (posts.length === 0) throw new Error('No posts parsed');

      // render
      renderNewsList(posts);
    } catch (err) {
      console.warn('Could not fetch/parse channel page (likely CORS). Falling back to iframe.', err);
      renderFallbackIframe();
    }
  }

  // open/close modal
  function openNewsModal() {
    newsBackdrop.classList.add('open');
    newsBackdrop.setAttribute('aria-hidden','false');
    // try to load parsed posts; if fails, fallback iframe inside function
    loadNewsParsed(8);
  }
  function closeNewsModal() {
    newsBackdrop.classList.remove('open');
    newsBackdrop.setAttribute('aria-hidden','true');
    // optional: clear iframe to stop media
    const iframe = newsContent.querySelector('iframe');
    if (iframe) iframe.src = 'about:blank';
  }

  // attach listeners
  tNews.addEventListener('click', ()=> {
    openNewsModal();
    burstSparkles(6);
  });
  newsClose.addEventListener('click', closeNewsModal);
  newsBackdrop.addEventListener('click', (ev) => {
    if (ev.target === newsBackdrop) closeNewsModal();
  });

  // newsOpenChannel set earlier in markup; ensure it points to channel
  newsOpenChannel.href = NEWS_S_URL;

  /*********************
   * Accessibility: trap focus inside modal when open (light)
   *********************/
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && newsBackdrop.classList.contains('open')) {
      closeNewsModal();
    }
  });

</script>
</body>
</html>
