<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Profiles ‚Äî Auroreine</title>

<style>
/* ===========================
      BASE & VARIABLES
=========================== */
@font-face {
  font-family: 'SwirlyCanalope';
  src: url('SwirlyCanalopePERSONALUSE-Regular.woff2') format('woff2'),
       url('SwirlyCanalopePERSONALUSE-Regular.woff') format('woff');
  font-display: swap;
}

:root {
  --text:#f5f3ff;
  --soft:#b8b5d0;
  --accent:#f7d6ff;

  --max-width:480px;
  --tab-min-width:92px; /* slightly reduced so news tab fits */
  --card-bg:rgba(255,255,255,0.02);
}

* { box-sizing:border-box; }

html, body {
  margin:0; height:100%;
  font-family:system-ui, -apple-system, "Segoe UI", Roboto;
}

body {
  display:flex; justify-content:center; align-items:center;
  background:radial-gradient(1200px 800px at 10% 10%, #1c1530 0%, #07060a 45%, #03020a 100%);
  color:var(--text);
  padding:20px;
  overflow:hidden;
}

/* ===========================
      CARD WRAPPER
=========================== */
.shell { width:100%; max-width:var(--max-width); position:relative; z-index:10; }

.card {
  border-radius:18px;
  padding:18px;
  background:linear-gradient(180deg, var(--card-bg), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.03);
  box-shadow:0 18px 40px rgba(0,0,0,0.6);
  opacity:0;
  transform:translateY(10px);
  transition: opacity .45s ease .35s, transform .45s ease .35s;
  backdrop-filter:blur(2px);
}

.content-visible .card { opacity:1; transform:none; }

/* ===========================
      HEADER TITLE
=========================== */
.title-row.simple-one {
  display:flex; justify-content:center; align-items:center;
  padding:10px 0 16px;
}

.simple-name {
  font-size:17px;
  font-weight:700;
  letter-spacing:.03em;
  margin:0;
}

/* ===========================
         TABS
=========================== */
.tabs {
  display:flex;
  gap:8px;
  margin-bottom:10px;
  align-items:center; /* ensure vertical alignment */
}

/* default tab styling */
.tab {
  min-width:var(--tab-min-width);
  flex:1 1 auto; /* allow the two main tabs to share space */
  padding:8px 10px;
  border-radius:999px;
  font-size:13px;
  text-align:center;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;

  background:transparent;
  color:var(--soft);
  border:1px solid transparent;

  cursor:pointer;
}

/* active tab */
.tab.active {
  background:linear-gradient(180deg, rgba(247,214,255,0.06), rgba(247,214,255,0.03));
  border-color:rgba(247,214,255,0.12);
  color:var(--text);
}

/* micro-hover */
.tab:hover {
  transform:translateY(-2px);
  transition:transform 120ms ease;
  box-shadow:0 6px 16px rgba(0,0,0,0.12);
}

/* ===========================
      NEWS TAB (üóûÔ∏è) - compact inline
=========================== */
#tab-news {
  min-width:46px;
  max-width:46px;
  padding:8px 0;

  display:flex;
  align-items:center;
  justify-content:center;

  font-size:16px;
  line-height:1;

  flex:0 0 46px; /* keep it compact and not flex-grow */
}

/* same active glow as tabs */
#tab-news.active {
  background:linear-gradient(180deg, rgba(247,214,255,0.06), rgba(247,214,255,0.03));
  border-color:rgba(247,214,255,0.12);
  color:var(--text);
}

/* reduce visual size of the other tabs a bit so news fits */
.tab.small {
  font-size:11px;
  padding:6px 8px;
  line-height:1;
  max-width:160px;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

/* ===========================
         PROFILE CARD
=========================== */
.profile {
  padding:12px;
  border-radius:14px;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(9,9,18,0.95));
  border:1px solid rgba(255,255,255,0.02);
  margin-bottom:14px;
}

.profile h2 { margin:0 0 4px; font-size:15px; font-weight:600; }

.profile small {
  display:block;
  font-size:11px;
  color:var(--soft);
  margin-bottom:6px;
}

.profile p {
  font-family:'SwirlyCanalope', serif;
  font-size:18px;
  color:#eedeff;
  line-height:1.55;
  margin:0;
}

/* ===========================
     BUTTON ROW (fav/play)
=========================== */
.btn-row { display:flex; gap:8px; }

button.primary,
button.ghost {
  flex:1;
  padding:10px 16px;
  border-radius:999px;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

button.primary {
  background:#f5f0ff; color:#161622;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
}

button.ghost {
  background:transparent;
  color:var(--soft);
  border:1px solid rgba(255,255,255,0.06);
}

/* favorite icon */
#favIcon {
  width:18px; height:18px; object-fit:contain; border-radius:6px;
}

.fav-gif-in {
  animation:favGifIn .26s ease both;
}
@keyframes favGifIn {
  from { opacity:0; transform:scale(.92); }
  to   { opacity:1; transform:scale(1); }
}

/* ===========================
   FAVORITE ACTIVE + FOX WIGGLE
=========================== */
@keyframes foxWiggle {
  0%   { transform: rotate(0deg) scale(1); }
  25%  { transform: rotate(-6deg) scale(1.08); }
  50%  { transform: rotate(4deg) scale(1.06); }
  75%  { transform: rotate(-3deg) scale(1.05); }
  100% { transform: rotate(0deg) scale(1.06); }
}

/* fav active (glow, gradient, wiggle) */
#favBtn.fav-active {
  color: #161622;
  background: linear-gradient(180deg, #fceeff, #f7d6ff);
  text-shadow: 0 0 6px rgba(255,180,255,0.45), 0 0 12px rgba(255,150,255,0.12);
  box-shadow: 0 10px 26px rgba(180,120,255,0.14);
  animation: foxWiggle 0.45s ease-out;
  transform-origin: center center;
}

/* ===========================
   PLAY BUTTON style (match favorite)
=========================== */
#playBtn {
  background:#f5f0ff;
  color:#161622;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
  padding-left:18px;
  padding-right:18px;
  border-radius:999px;
  border: none;
}

#playBtn.playing {
  background: linear-gradient(180deg, #fceeff, #f7d6ff);
  color:#161622;
  text-shadow: 0 0 6px rgba(255,180,255,0.45), 0 0 12px rgba(255,150,255,0.12);
  box-shadow: 0 10px 26px rgba(180,120,255,0.14);
  animation: foxWiggle 0.45s ease-out;
  transform-origin: center center;
}

#playBtn:active, #favBtn:active { transform: scale(0.99); transition: transform 80ms ease; }

/* ===========================
        DOOR OVERLAY
=========================== */
.door-overlay {
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.hidden-overlay { display:none !important; }

/* ===========================
   tambahan CSS (modal, sparkles, replay)
=========================== */
.replay {
  position:fixed;
  right:18px;
  bottom:18px;
  z-index:10010;
  background:rgba(255,255,255,0.04);
  color:var(--soft);
  border:1px solid rgba(255,255,255,0.03);
  padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer;
}

/* sparkle */
.sparkle-pop {
  position:absolute;width:6px;height:6px;border-radius:50%;
  background:radial-gradient(circle,#ffffff 0%,#e7d4ff 60%,transparent 100%);
  opacity:0; animation:sparkleFade 1.2s ease-out forwards; pointer-events:none; filter:blur(0.4px);
}
@keyframes sparkleFade {
  0% { transform: translateY(0) scale(.5); opacity:0; }
  15% { transform: translateY(-4px) scale(1); opacity:.95; }
  50% { transform: translateY(-12px) scale(1.15); opacity:.8; }
  100% { transform: translateY(-22px) scale(.7); opacity:0; }
}

/* NEWS modal */
.news-modal-backdrop {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background: rgba(5,4,8,0.6); z-index:10020; padding:20px;
}
.news-modal-backdrop.open { display:flex; }

.news-modal {
  width:min(720px,calc(100% - 40px));
  max-height:80vh; overflow:auto;
  background:linear-gradient(180deg, rgba(12,10,14,0.96), rgba(16,14,20,0.98));
  border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.04);
  box-shadow:0 30px 80px rgba(0,0,0,0.6); color:var(--text);
}
.news-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }

/* <-- CHANGED: smaller header font so it's not too large --> */
.news-header .news-title-main {
  font-weight:700;
  font-size:13px; /* reduced from 16 */
  color:var(--text);
  margin:0;
}

/* small subtitle (if needed) */
.news-header .news-sub { font-size:12px; color:var(--soft); }

/* news list */
.news-list { display:flex; flex-direction:column; gap:10px; }
.news-item {
  display:flex; gap:10px; align-items:flex-start; padding:10px; border-radius:12px;
  background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));
  border:1px solid rgba(255,255,255,0.02);
}
.news-thumb { width:74px; height:74px; border-radius:10px; background:#111; object-fit:cover; flex-shrink:0; }
.news-meta { flex:1; min-width:0; }
.news-title { font-weight:700; font-size:13px; margin:0 0 4px 0; color:var(--text); }
.news-excerpt { font-size:13px; color:var(--soft); line-height:1.4; margin:0; max-height:3.2em; overflow:hidden; }
.news-actions { display:flex; gap:8px; margin-top:8px; }
.news-fallback-iframe { width:100%; height:60vh; border-radius:10px; border:1px solid rgba(255,255,255,0.04); }

.news-empty { text-align:center; color:var(--soft); padding:26px 10px; }

/* make Open in Telegram small like Close */
.news-open-tele,
.news-open-tele.small-link {
  background: transparent;
  color: var(--soft);
  border: 1px solid rgba(255,255,255,0.04);
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
}

/* thumbnail grid fallback */
.news-grid {
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
  gap:10px;
  margin-top:6px;
}
.news-grid .grid-item {
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:10px; padding:8px; text-align:center; border:1px solid rgba(255,255,255,0.02);
}
.news-grid .grid-thumb { width:100%; height:82px; object-fit:cover; border-radius:8px; background:#111; display:block; margin-bottom:8px; }

/* small-screen tweaks */
@media (max-width:520px) {
  .news-thumb { width:58px; height:58px; }
  .tab { min-width:82px; }
  #tab-news { flex:0 0 44px; min-width:44px; max-width:44px; }
}

/* ===========================
   MUSIC POPUP styles
=========================== */
.music-modal-backdrop {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background: rgba(5,4,8,0.6); z-index:10030; padding:20px;
}
.music-modal-backdrop.open { display:flex; }
.music-modal {
  width:min(520px,calc(100% - 40px));
  max-height:70vh; overflow:auto;
  background:linear-gradient(180deg, rgba(12,10,14,0.98), rgba(16,14,20,0.99));
  border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.04);
  box-shadow:0 30px 80px rgba(0,0,0,0.6); color:var(--text);
}
.music-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
.music-title { font-weight:700; font-size:13px; margin:0; }
.music-controls { display:flex; gap:8px; align-items:center; }
.music-inputs { display:flex; gap:8px; margin-bottom:10px; }
.music-inputs input[type="text"] { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:var(--text); }
.music-inputs input[type="file"] { display:block; }
.music-list { display:flex; flex-direction:column; gap:8px; }
.music-item { display:flex; gap:8px; align-items:center; padding:8px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006)); border:1px solid rgba(255,255,255,0.02); }
.music-item .meta { flex:1; min-width:0; font-size:13px; color:var(--soft); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.music-item button { padding:6px 8px; border-radius:8px; background:transparent; color:var(--soft); border:1px solid rgba(255,255,255,0.04); cursor:pointer; }
.music-player-row { display:flex; gap:8px; align-items:center; margin-top:10px; }
.music-player-row .play-btn { padding:8px 12px; border-radius:8px; background:#f5f0ff; color:#161622; border:none; cursor:pointer; }

</style>
</head>
<body>
  <!-- DOOR OVERLAY -->
  <div class="door-overlay" id="doorOverlay" aria-hidden="true">
    <div class="door-wrap" id="doorWrap" style="width:100%;max-width:900px;height:100vh;display:flex;perspective:1400px;">
      <div class="leaf left" style="flex:1;height:100vh;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(180,140,255,0.10), rgba(120,90,180,0.12));box-shadow:inset 0 1px 0 rgba(255,255,255,0.08),0 30px 80px rgba(60,0,120,0.45);">
        <div class="label" style="color:var(--soft);font-size:14px">‚Äî S15 ‚Äî</div>
      </div>
      <div class="leaf right" style="flex:1;height:100vh;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(180,140,255,0.10), rgba(120,90,180,0.12));box-shadow:inset 0 1px 0 rgba(255,255,255,0.08),0 30px 80px rgba(60,0,120,0.45);">
        <div class="label" style="color:var(--soft);font-size:14px">‚Äî atelier ‚Äî</div>
      </div>
    </div>
  </div>

  <!-- MAIN SHELL -->
  <div class="shell" id="shell">
    <div class="card" id="card">

      <!-- HEADER -->
      <div class="title-row simple-one" role="banner">
        <h1 class="simple-name">Auroreine</h1>
      </div>

      <!-- TABS -->
      <div class="tabs" id="tabs">
        <button class="tab small active" id="tab-zhou">‚ú¶ Muse</button>
        <button class="tab small" id="tab-rp">‚úß Another Universe</button>

        <!-- compact inline news tab -->
        <button id="tab-news" class="tab" title="Latest news">üóûÔ∏è</button>

        <!-- music popup tab -->
        <button id="tab-music" class="tab" title="Music & playlist">‚ô™</button>
      </div>

      <!-- PROFILE -->
      <div class="profile" id="profile">
        <h2 id="profile-title">Zhou Xinyu</h2>
        <small id="profile-tag">Muse ¬∑ TripleS</small>
        <p id="profile-text">Soft-spoken, stage-light kind of pretty.
Carries winter glow and slow-day calm,
like a quiet verse written in silver.</p>
      </div>

      <!-- BUTTONS -->
      <div class="btn-row">
        <button class="primary" id="favBtn" aria-pressed="false" title="Favorite">
          <img id="favIcon" alt="fox icon" src="foxfixfix.gif" aria-hidden="true">
          <span class="label-text">Favorite</span>
        </button>

        <button class="ghost" id="playBtn" aria-pressed="false" title="Play preview">‚ñ∂ Play</button>
      </div>

      <!-- AUDIO -->
      <audio id="profileAudio" preload="auto">
        <source src="playsongnew.mp3" type="audio/mpeg">
      </audio>

      <div class="helper" style="margin-top:10px;font-size:10px;color:#8581a1;text-align:center;">Your choice will be sent back to the bot as a tiny note.</div>
    </div>
  </div>

  <!-- optional door sound -->
  <audio id="doorAudio" preload="auto">
    <source src="door_open.mp3" type="audio/mpeg">
  </audio>

  <button class="replay" id="replayBtn" title="Replay door effect">Replay ‚ú®</button>

  <!-- NEWS modal -->
  <div class="news-modal-backdrop" id="newsBackdrop" aria-hidden="true">
    <div class="news-modal" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
<div class="news-header">
  <div style="display:flex;align-items:center;gap:12px;">
    <div>
      <!-- smaller title (tidak terlalu besar) -->
      <div id="newsTitle" class="news-title-main">Recently update of Meredith Melrose.</div>
      <div class="news-sub" style="display:none;">Newest at top ‚Äî click to open a post</div>
    </div>
  </div>

  <div style="display:flex;gap:8px;align-items:center;">
    <button class="news-close" id="newsClose">Close</button>
    <!-- make Open in Telegram small like Close -->
    <a class="news-open-tele small-link" id="newsOpenChannel" target="_blank" rel="noopener noreferrer" href="https://t.me/S15XINYU">Open in Telegram</a>
  </div>
</div>

      <div id="newsContent">
        <div class="news-empty" id="newsLoading">Loading latest posts‚Ä¶</div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   Core JS: tabs, fav, audio, door, news
=========================== */

/* Telegram WebApp compatibility (optional) */
const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
if (tg) try { tg.expand(); tg.ready(); } catch(e){}

/* Elements */
const shell = document.getElementById('shell');
const doorOverlay = document.getElementById('doorOverlay');
const doorWrap = document.getElementById('doorWrap');
const doorAudio = document.getElementById('doorAudio');
const replayBtn = document.getElementById('replayBtn');

const tZ = document.getElementById('tab-zhou');
const tR = document.getElementById('tab-rp');
const tNews = document.getElementById('tab-news');

const profileAudio = document.getElementById('profileAudio');
const favBtn = document.getElementById('favBtn');
const playBtn = document.getElementById('playBtn');
const favIcon = document.getElementById('favIcon');

const newsBackdrop = document.getElementById('newsBackdrop');
const newsContent = document.getElementById('newsContent');
const newsClose = document.getElementById('newsClose');
const newsOpenChannel = document.getElementById('newsOpenChannel');

const profiles = {
  zhou: {
    title: "Zhou Xinyu",
    tag: "Muse ¬∑ TripleS",
    text: "Soft-spoken, stage-light kind of pretty.\nCarries winter glow and slow-day calm,\nlike a quiet verse written in silver."
  },
  rp: {
    title: "Meredith Melrose",
    tag: "S15 ¬∑ night-coded",
    text: "Writes in lowercase and starlight.\nHalf diary, half song, always a little\nlate to leave the dream."
  }
};

let selected = 'zhou';

/* ===========================
   Sparkle helpers
=========================== */
function makeSparkle(x, y, size = null) {
  const profileBox = document.getElementById("profile");
  if (!profileBox) return;
  const sp = document.createElement("div");
  sp.className = "sparkle-pop";
  const s = size || (6 + Math.floor(Math.random()*8));
  sp.style.width = s + "px";
  sp.style.height = s + "px";
  sp.style.left = Math.round(x) + "px";
  sp.style.top = Math.round(y) + "px";
  sp.style.transform = `translateY(0) scale(${0.6 + Math.random()*0.9})`;
  profileBox.appendChild(sp);
  setTimeout(() => { if (sp && sp.parentNode) sp.parentNode.removeChild(sp); }, 1400);
}
function burstSparkles(count = 5) {
  const box = document.getElementById("profile");
  if (!box) return;
  const rect = box.getBoundingClientRect();
  for (let i = 0; i < count; i++) {
    const delay = Math.random() * 180;
    setTimeout(() => {
      const paddingX = Math.max(8, rect.width * 0.06);
      const paddingY = Math.max(8, rect.height * 0.06);
      const x = Math.random() * (rect.width - paddingX*2) + paddingX;
      const y = Math.random() * (rect.height - paddingY*2) + paddingY;
      makeSparkle(x, y);
    }, delay);
  }
}

/* ===========================
   FAVORITE (localStorage)
=========================== */
const STORAGE_KEY = 'miniapp_favs_v1';
function loadFavs() {
  try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {}; } catch(e){ return {}; }
}
function saveFavs(obj) {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){}
}
function setFavState(isFav) {
  favBtn.setAttribute('aria-pressed', isFav ? 'true' : 'false');
  const label = favBtn.querySelector('.label-text');
  if (label) label.textContent = isFav ? 'Favorited' : 'Favorite';
  try {
    favIcon.src = 'foxfixfix.gif';
    if (isFav) {
      favIcon.classList.add('fav-gif-in');
      favBtn.classList.add('fav-active');
      burstSparkles(5);
    } else {
      favIcon.classList.remove('fav-gif-in');
      favBtn.classList.remove('fav-active');
    }
  } catch(e){
    if (favIcon && favIcon.parentNode) favIcon.parentNode.removeChild(favIcon);
    if (label) label.textContent = isFav ? 'Favorited' : 'Favorite';
  }
}
favBtn.addEventListener('click', () => {
  const favs = loadFavs(); const currently = !!favs[selected];
  if (currently) delete favs[selected]; else favs[selected] = { ts: Date.now() };
  saveFavs(favs); setFavState(!currently);
  if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.sendData) {
    try { window.Telegram.WebApp.sendData(JSON.stringify({ type: 'fav', profile: selected, fav: !currently })); } catch(e){}
  }
});
function initFavUIForCurrent() {
  const favs = loadFavs(); const isFav = !!favs[selected];
  favIcon.src = 'foxfixfix.gif';
  setFavState(isFav);
}

/* ===========================
   AUDIO play/pause handling
=========================== */
const PROFILE_AUDIO_MAP = { zhou: 'playsongnew.mp3', rp: 'playsongnew.mp3' };
function currentProfileAudioFile() { return PROFILE_AUDIO_MAP[selected] || 'playsongnew.mp3'; }

playBtn.addEventListener('click', async () => {
  if (!profileAudio) { alert('Audio not available. Tambahkan playsongnew.mp3 di folder yang sama dengan file ini.'); return; }
  const desired = currentProfileAudioFile();
  const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || '';
  if (currentSource !== desired) { profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`; try { profileAudio.load(); } catch(e){} }
  try {
    if (profileAudio.paused) {
      await profileAudio.play();
      playBtn.classList.add('playing');
      playBtn.textContent = '‚è∏ Pause';
      playBtn.setAttribute('aria-pressed','true');
    } else {
      profileAudio.pause();
      playBtn.classList.remove('playing');
      playBtn.textContent = '‚ñ∂ Play';
      playBtn.setAttribute('aria-pressed','false');
    }
  } catch (err) {
    playBtn.classList.remove('playing'); playBtn.textContent = '‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false');
    console.warn('Audio play error', err); alert('Gagal memutar audio ‚Äî coba tekan lagi atau periksa file audio (playsongnew.mp3).');
  }
});
if (profileAudio) {
  profileAudio.addEventListener('play', ()=>{ playBtn.classList.add('playing'); playBtn.textContent='‚è∏ Pause'; playBtn.setAttribute('aria-pressed','true'); });
  profileAudio.addEventListener('pause', ()=>{ playBtn.classList.remove('playing'); playBtn.textContent='‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false'); });
  profileAudio.addEventListener('ended', ()=>{ playBtn.classList.remove('playing'); playBtn.textContent='‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false'); try{ profileAudio.currentTime=0;}catch(e){} });
}

/* ===========================
   TAB switching (preserve audio state)
=========================== */
function setActive(k){
  selected = k;
  const d = profiles[k];
  document.getElementById('profile-title').textContent = d.title;
  document.getElementById('profile-tag').textContent = d.tag;
  document.getElementById('profile-text').textContent = d.text;

  // update tab active classes
  [tZ,tR,tNews].forEach(el=> el.classList.remove('active'));
  if (k==='zhou') tZ.classList.add('active');
  else if (k==='rp') tR.classList.add('active');

  // handle audio source switching without interrupting play state
  if (!profileAudio) return;
  try {
    const desired = currentProfileAudioFile();
    const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || '';
    if (currentSource === desired) return;
    const wasPlaying = !profileAudio.paused && !profileAudio.ended;
    const currentTime = Math.max(0, Math.min(profileAudio.currentTime || 0, 999999));
    profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`;
    try { profileAudio.load(); } catch(e){}
    function tryRestore() {
      try {
        if (profileAudio.duration && !isNaN(profileAudio.duration)) {
          const t = Math.min(currentTime, Math.max(0, profileAudio.duration - 0.01));
          profileAudio.currentTime = t;
        } else profileAudio.currentTime = currentTime;
      } catch(err){}
      if (wasPlaying) profileAudio.play().catch(()=>{});
      profileAudio.removeEventListener('loadedmetadata', tryRestore);
    }
    if (profileAudio.readyState >= 1) tryRestore(); else profileAudio.addEventListener('loadedmetadata', tryRestore);
  } catch(err){ console.warn('Error while switching profile audio (non-fatal):', err); }
}

/* attach tab listeners */
// use reduced-size class for zhou/rp tabs so the news fits nicely inline
if (tZ) tZ.addEventListener('click', ()=> { setActive('zhou'); burstSparkles(6); });
if (tR) tR.addEventListener('click', ()=> { setActive('rp'); burstSparkles(6); });

/* ===========================
   DOOR animation
=========================== */
function openDoor(playSound=true){
  setTimeout(()=> shell.classList.add('content-visible'), 1200);
  if (playSound && doorAudio && doorAudio.src) { doorAudio.currentTime = 0; doorAudio.play().catch(()=>{}); }
  doorWrap.classList.add('door-opening');
  setTimeout(()=> { doorOverlay.classList.add('hidden-overlay'); shell.classList.add('content-visible'); }, 1600);
}
setTimeout(()=> openDoor(true), 260);
replayBtn.addEventListener('click', ()=> {
  doorOverlay.classList.remove('hidden-overlay');
  doorWrap.classList.remove('door-opening');
  shell.classList.remove('content-visible');
  void doorWrap.offsetWidth;
  setTimeout(()=> openDoor(true), 80);
});

/* responsive tabs helper */
(function(){
  function updateTabsMode() {
    const tabsRoot = document.getElementById('tabs');
    if (!tabsRoot) return;
    if (window.matchMedia('(max-width:639px)').matches) tabsRoot.classList.add('tabs-scroll');
    else tabsRoot.classList.remove('tabs-scroll');
  }
  updateTabsMode();
  window.addEventListener('resize', updateTabsMode);
  window.addEventListener('orientationchange', updateTabsMode);
})();

/* initialize favorite UI on load */
window.addEventListener('load', ()=> { initFavUIForCurrent(); });

/* ===========================
   NEWS modal logic (fetch + fallback thumbnail grid)
=========================== */
const NEWS_CHANNEL = 'S15XINYU';
const NEWS_S_URL = `https://t.me/s/${NEWS_CHANNEL}`;

/* utility */
function truncateText(s, n = 140) {
  if (!s) return '';
  s = s.replace(/\s+/g,' ').trim();
  if (s.length <= n) return s;
  return s.slice(0, n-1).trim() + '‚Ä¶';
}

/* render list (normal) */
function renderNewsList(posts) {
  if (!posts || posts.length === 0) { newsContent.innerHTML = '<div class="news-empty">No recent posts were found.</div>'; return; }
  const list = document.createElement('div'); list.className = 'news-list';
  posts.forEach(post => {
    const item = document.createElement('div'); item.className = 'news-item';
    const thumb = document.createElement('img'); thumb.className = 'news-thumb'; thumb.alt = 'thumb'; thumb.loading='lazy';
    if (post.thumb) thumb.src = post.thumb; else { thumb.style.background = '#111'; thumb.src = ''; }
    const meta = document.createElement('div'); meta.className = 'news-meta';
    const title = document.createElement('div'); title.className = 'news-title'; title.textContent = post.timeStr || `S15XINYU`;
    const excerpt = document.createElement('p'); excerpt.className='news-excerpt'; excerpt.textContent = truncateText(post.excerpt || post.text || '', 140);
    const actions = document.createElement('div'); actions.className='news-actions';
    const btnOpen = document.createElement('a'); btnOpen.className='news-open-tele'; btnOpen.textContent='Open in Telegram';
    btnOpen.href = post.link || NEWS_S_URL; btnOpen.target='_blank'; btnOpen.rel='noopener noreferrer';
    actions.appendChild(btnOpen);
    meta.appendChild(title); meta.appendChild(excerpt); meta.appendChild(actions);
    item.appendChild(thumb); item.appendChild(meta); list.appendChild(item);
  });
  newsContent.innerHTML = ''; newsContent.appendChild(list);
}

/* NEW: render a thumbnail grid as fallback (white area becomes grid of thumbnails) */
function renderFallbackThumbnails(posts) {
  newsContent.innerHTML = '';
  const grid = document.createElement('div'); grid.className = 'news-grid';
  if (!posts || posts.length === 0) {
    // If no posts info, show message + iframe fallback button
    const empty = document.createElement('div'); empty.className = 'news-empty';
    empty.textContent = 'Unable to fetch previews from the channel. Try "Open in Telegram".';
    newsContent.appendChild(empty);
    const openBtn = document.createElement('a'); openBtn.className='news-open-tele'; openBtn.textContent='Open channel in Telegram';
    openBtn.href = NEWS_S_URL; openBtn.target = '_blank'; openBtn.rel = 'noopener noreferrer';
    newsContent.appendChild(openBtn);
    // as last resort, also show iframe (keeps original behaviour)
    const iframe = document.createElement('iframe'); iframe.className='news-fallback-iframe';
    iframe.src = NEWS_S_URL; iframe.loading = 'lazy'; iframe.referrerPolicy = 'no-referrer';
    newsContent.appendChild(iframe);
    return;
  }
  posts.forEach(p => {
    const item = document.createElement('div'); item.className = 'grid-item';
    const a = document.createElement('a'); a.href = p.link || NEWS_S_URL; a.target = '_blank'; a.rel = 'noopener noreferrer';
    const img = document.createElement('img'); img.className='grid-thumb'; img.alt = p.timeStr || 'post';
    if (p.thumb) img.src = p.thumb; else img.src = ''; // empty src => shows background
    const t = document.createElement('div'); t.className='news-title'; t.style.fontSize='12px'; t.style.margin='0'; t.style.color='var(--soft)';
    t.textContent = truncateText(p.excerpt || p.timeStr || '', 80);
    a.appendChild(img);
    item.appendChild(a);
    item.appendChild(t);
    grid.appendChild(item);
  });
  newsContent.appendChild(grid);
}

/* fallback iframe (original) */
function renderFallbackIframe() {
  newsContent.innerHTML = '';
  const iframe = document.createElement('iframe'); iframe.className = 'news-fallback-iframe';
  iframe.src = NEWS_S_URL; iframe.loading = 'lazy'; iframe.referrerPolicy = 'no-referrer';
  newsContent.appendChild(iframe);
}

/* try to load and parse the t.me summary (primary attempt) */
async function loadNewsParsed(maxPosts = 6) {
  newsContent.innerHTML = '<div class="news-empty">Loading latest posts‚Ä¶</div>';
  try {
    const res = await fetch(NEWS_S_URL, { method:'GET', mode:'cors' });
    if (!res.ok) throw new Error('Network response not ok: ' + res.status);
    const text = await res.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(text, 'text/html');
    const msgs = Array.from(doc.querySelectorAll('.tgme_widget_message, .tgme_widget_message_wrap, .tme_widget_message'));
    if (!msgs || msgs.length === 0) {
      const alt = Array.from(doc.querySelectorAll('.tgme_widget_message_text, .message, .tgme_widget_message_text'));
      if (!alt || alt.length === 0) throw new Error('No message nodes found');
    }
    const posts = [];
    for (let i = 0; i < msgs.length && posts.length < maxPosts; i++) {
      const m = msgs[i];
      const textNode = m.querySelector('.tgme_widget_message_text') || m.querySelector('.message_text') || m.querySelector('p') || m;
      let excerpt = ''; if (textNode) excerpt = (textNode.textContent || textNode.innerText || '').trim();
      let thumb = null;
      const photo = m.querySelector('.tgme_widget_message_photo') || m.querySelector('img');
      if (photo) {
        const img = photo.querySelector ? photo.querySelector('img') : null;
        if (img && (img.getAttribute('src') || img.getAttribute('data-src'))) thumb = img.getAttribute('src') || img.getAttribute('data-src');
        else if (photo.style && photo.style.backgroundImage) {
          const bg = photo.style.backgroundImage; const match = bg.match(/url\(["']?(.*?)["']?\)/);
          if (match) thumb = match[1];
        } else if (photo.getAttribute && (photo.getAttribute('src') || photo.getAttribute('data-src'))) thumb = photo.getAttribute('src') || photo.getAttribute('data-src');
      }
      let link = null; const a = m.querySelector('a.tgme_widget_message_date') || m.querySelector('a[href*="/" + NEWS_CHANNEL + "/"]') || m.querySelector('a');
      if (a && a.href) link = a.href;
      let timeStr = ''; const timeNode = m.querySelector('.tgme_widget_message_date') || m.querySelector('time');
      if (timeNode) timeStr = timeNode.textContent || timeNode.getAttribute('datetime') || '';
      posts.push({ excerpt, thumb, link, timeStr });
    }
    if (posts.length === 0) throw new Error('No posts parsed');
    renderNewsList(posts);
  } catch (err) {
    console.warn('Could not fetch/parse channel page (likely CORS). Trying proxy...', err);
    // Try a simple proxy that returns the remote page as HTML/text (best-effort)
    try {
      // r.jina.ai is an example "textify" proxy ‚Äî if you host your own proxy, replace here.
      const proxyUrl = `https://r.jina.ai/http://t.me/s/${NEWS_CHANNEL}`;
      const r = await fetch(proxyUrl, { method:'GET' });
      if (!r.ok) throw new Error('Proxy failed: ' + r.status);
      const txt = await r.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(txt, 'text/html');
      const msgs = Array.from(doc.querySelectorAll('.tgme_widget_message, .tgme_widget_message_wrap, .tme_widget_message'));
      const posts = [];
      for (let i = 0; i < msgs.length && posts.length < 8; i++) {
        const m = msgs[i];
        const textNode = m.querySelector('.tgme_widget_message_text') || m.querySelector('.message_text') || m.querySelector('p') || m;
        let excerpt = ''; if (textNode) excerpt = (textNode.textContent || textNode.innerText || '').trim();
        let thumb = null;
        const photo = m.querySelector('.tgme_widget_message_photo') || m.querySelector('img');
        if (photo) {
          const img = photo.querySelector ? photo.querySelector('img') : null;
          if (img && (img.getAttribute('src') || img.getAttribute('data-src'))) thumb = img.getAttribute('src') || img.getAttribute('data-src');
          else if (photo.style && photo.style.backgroundImage) {
            const bg = photo.style.backgroundImage; const match = bg.match(/url\(["']?(.*?)["']?\)/);
            if (match) thumb = match[1];
          } else if (photo.getAttribute && (photo.getAttribute('src') || photo.getAttribute('data-src'))) thumb = photo.getAttribute('src') || photo.getAttribute('data-src');
        }
        let link = null; const a = m.querySelector('a.tgme_widget_message_date') || m.querySelector('a[href*="/" + NEWS_CHANNEL + "/"]') || m.querySelector('a');
        if (a && a.href) link = a.href;
        let timeStr = ''; const timeNode = m.querySelector('.tgme_widget_message_date') || m.querySelector('time');
        if (timeNode) timeStr = timeNode.textContent || timeNode.getAttribute('datetime') || '';
        posts.push({ excerpt, thumb, link, timeStr });
      }
      if (posts.length > 0) {
        // show as thumbnail grid (white area becomes grid)
        renderFallbackThumbnails(posts);
        return;
      } else {
        throw new Error('Proxy returned but no posts parsed');
      }
    } catch (err2) {
      console.warn('Proxy attempt failed ‚Äî falling back to iframe', err2);
      // final fallback: iframe
      renderFallbackIframe();
    }
  }
}

/* open/close modal */
function openNewsModal() {
  newsBackdrop.classList.add('open'); newsBackdrop.setAttribute('aria-hidden','false');
  loadNewsParsed(8);
}
function closeNewsModal() {
  newsBackdrop.classList.remove('open'); newsBackdrop.setAttribute('aria-hidden','true');
  const iframe = newsContent.querySelector('iframe'); if (iframe) iframe.src = 'about:blank';
}

/* attach listeners */
tNews.addEventListener('click', ()=> { openNewsModal(); burstSparkles(6); tNews.classList.add('active'); });
newsClose.addEventListener('click', closeNewsModal);
newsBackdrop.addEventListener('click', (ev)=> { if (ev.target === newsBackdrop) closeNewsModal(); });
newsOpenChannel.href = NEWS_S_URL;

/* ESC to close */
document.addEventListener('keydown', (e)=> { if (e.key === 'Escape' && newsBackdrop.classList.contains('open')) closeNewsModal(); });


/* ===========================
   MUSIC POPUP logic
=========================== */
// music modal elements
const tabMusic = document.getElementById('tab-music');

// create modal HTML and append to body via JS so it doesn't clutter earlier HTML
const musicModalHtml = `
<div class="music-modal-backdrop" id="musicBackdrop" aria-hidden="true">
  <div class="music-modal" role="dialog" aria-modal="true" aria-labelledby="musicTitle">
    <div class="music-header">
      <div style="display:flex;align-items:center;gap:12px;"><div id="musicTitle" class="music-title">Playlist ‚Äî Music</div></div>
      <div style="display:flex;gap:8px;align-items:center;"><button id="musicClose">Close</button></div>
    </div>
    <div class="music-inputs">
      <input type="text" id="musicUrlInput" placeholder="Paste audio URL (mp3) and press Add" aria-label="Audio URL">
      <button id="musicAddUrl">Add</button>
    </div>
    <div style="font-size:12px;color:var(--soft);margin-bottom:8px;">Or upload local file (will use blob URL)</div>
    <div style="margin-bottom:8px;"><input type="file" id="musicFileInput" accept="audio/*"></div>
    <div class="music-list" id="musicList"></div>
    <div class="music-player-row">
      <button class="play-btn" id="musicPlayPause">‚ñ∂ Play</button>
      <div style="font-size:12px;color:var(--soft);">Now playing: <span id="musicNow">‚Äî</span></div>
    </div>
  </div>
</div>`;

document.body.insertAdjacentHTML('beforeend', musicModalHtml);

const musicBackdrop = document.getElementById('musicBackdrop');
const musicClose = document.getElementById('musicClose');
const musicAddUrl = document.getElementById('musicAddUrl');
const musicUrlInput = document.getElementById('musicUrlInput');
const musicFileInput = document.getElementById('musicFileInput');
const musicList = document.getElementById('musicList');
const musicPlayPause = document.getElementById('musicPlayPause');
const musicNow = document.getElementById('musicNow');

// create hidden audio player
const musicPlayer = document.createElement('audio'); musicPlayer.id = 'musicPlayer'; musicPlayer.preload = 'metadata'; document.body.appendChild(musicPlayer);

const PLAYLIST_KEY = 'miniapp_playlist_v1';
function loadPlaylist(){ try{ const raw = localStorage.getItem(PLAYLIST_KEY); return raw ? JSON.parse(raw) : []; }catch(e){return [];} }
function savePlaylist(pl){ try{ localStorage.setItem(PLAYLIST_KEY, JSON.stringify(pl)); }catch(e){} }
let playlist = loadPlaylist();
let currentIndex = -1;

function renderPlaylist(){ musicList.innerHTML = '';
  playlist.forEach((it, idx)=>{
    const el = document.createElement('div'); el.className = 'music-item';
    const meta = document.createElement('div'); meta.className = 'meta'; meta.textContent = it.title || it.src || ('Track ' + (idx+1));
    const btnPlay = document.createElement('button'); btnPlay.textContent = (idx===currentIndex && !musicPlayer.paused) ? '‚è∏' : '‚ñ∂';
    btnPlay.addEventListener('click', ()=>{ playIndex(idx); });
    const btnRemove = document.createElement('button'); btnRemove.textContent = '‚úï'; btnRemove.title = 'Remove';
    btnRemove.addEventListener('click', ()=>{ playlist.splice(idx,1); savePlaylist(playlist); if (idx===currentIndex){ musicPlayer.pause(); currentIndex=-1; musicNow.textContent='‚Äî'; } renderPlaylist(); });
    el.appendChild(btnPlay); el.appendChild(meta); el.appendChild(btnRemove);
    musicList.appendChild(el);
  });
}

function addUrl(src){ if (!src) return; const item = { src, title: src.split('/').pop().split('?')[0] }; playlist.push(item); savePlaylist(playlist); renderPlaylist(); }

musicAddUrl.addEventListener('click', ()=>{ const v = musicUrlInput.value.trim(); if (!v) return; addUrl(v); musicUrlInput.value=''; });
musicUrlInput.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ musicAddUrl.click(); } });

musicFileInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0]; if (!f) return; const url = URL.createObjectURL(f); const item = { src: url, title: f.name }; playlist.push(item); savePlaylist(playlist); renderPlaylist(); musicFileInput.value='';
});

function playIndex(i){ if (i<0 || i>=playlist.length) return; const it = playlist[i]; if (!it) return; if (currentIndex===i){ if (!musicPlayer.paused){ musicPlayer.pause(); } else { musicPlayer.play(); } return; }
  currentIndex = i; musicPlayer.src = it.src; musicPlayer.play().catch(()=>{}); musicNow.textContent = it.title || it.src; renderPlaylist(); }

musicPlayPause.addEventListener('click', ()=>{
  if (!musicPlayer.src) { if (playlist.length>0) return playIndex(0); else return; }
  if (musicPlayer.paused) musicPlayer.play(); else musicPlayer.pause();
});

musicPlayer.addEventListener('play', ()=>{ musicPlayPause.textContent='‚è∏ Pause'; renderPlaylist(); });
musicPlayer.addEventListener('pause', ()=>{ musicPlayPause.textContent='‚ñ∂ Play'; renderPlaylist(); });
musicPlayer.addEventListener('ended', ()=>{ musicPlayPause.textContent='‚ñ∂ Play'; });

function openMusicModal(){ musicBackdrop.classList.add('open'); musicBackdrop.setAttribute('aria-hidden','false'); renderPlaylist(); }
function closeMusicModal(){ musicBackdrop.classList.remove('open'); musicBackdrop.setAttribute('aria-hidden','true'); }

if (tabMusic) tabMusic.addEventListener('click', ()=>{ openMusicModal(); burstSparkles(6); tabMusic.classList.add('active'); });
musicClose.addEventListener('click', closeMusicModal);
musicBackdrop.addEventListener('click', (ev)=>{ if (ev.target===musicBackdrop) closeMusicModal(); });

// keyboard close
document.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && musicBackdrop.classList.contains('open')) closeMusicModal(); });

</script>
</body>
</html>
