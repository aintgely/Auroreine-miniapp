<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Profiles ‚Äî Auroreine (with Animated iPods)</title>

<style>
/* ===========================
      BASE & VARIABLES
=========================== */
@font-face {
  font-family: 'SwirlyCanalope';
  src: url('SwirlyCanalopePERSONALUSE-Regular.woff2') format('woff2'),
       url('SwirlyCanalopePERSONALUSE-Regular.woff') format('woff');
  font-display: swap;
}
:root {
  --text:#f5f3ff;
  --soft:#b8b5d0;
  --accent:#f7d6ff;
  --ipod-cream: #fff6fb;
  --ipod-shadow: rgba(30,10,40,0.35);
  --max-width:480px;
  --tab-min-width:92px;
  --card-bg:rgba(255,255,255,0.02);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto}
body{display:flex;justify-content:center;align-items:center;background:radial-gradient(1200px 800px at 10% 10%,#1c1530 0%,#07060a 45%,#03020a 100%);color:var(--text);padding:20px;overflow:hidden}
.shell{width:100%;max-width:var(--max-width);position:relative;z-index:10}
.card{border-radius:18px;padding:18px;background:linear-gradient(180deg,var(--card-bg),rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 18px 40px rgba(0,0,0,0.6);opacity:0;transform:translateY(10px);transition:opacity .45s ease .35s, transform .45s ease .35s;backdrop-filter:blur(2px)}
.content-visible .card{opacity:1;transform:none}
/* Tabs / profile / buttons reused from original - omitted for brevity in CSS comments */
.tabs{display:flex;gap:8px;margin-bottom:10px;align-items:center}
.tab{min-width:var(--tab-min-width);flex:1 1 auto;padding:8px 10px;border-radius:999px;font-size:13px;text-align:center;background:transparent;color:var(--soft);border:1px solid transparent;cursor:pointer}
.tab.active{background:linear-gradient(180deg, rgba(247,214,255,0.06), rgba(247,214,255,0.03));border-color:rgba(247,214,255,0.12);color:var(--text)}
.tab.small{font-size:11px;padding:6px 8px}
.profile{padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(9,9,18,0.95));border:1px solid rgba(255,255,255,0.02);margin-bottom:14px}
.profile h2{margin:0 0 4px;font-size:15px;font-weight:600}
.profile small{display:block;font-size:11px;color:var(--soft);margin-bottom:6px}
.profile p{font-family:'SwirlyCanalope',serif;font-size:18px;color:#eedeff;line-height:1.55;margin:0}
.btn-row{display:flex;gap:8px}
button.primary,button.ghost{flex:1;padding:10px 16px;border-radius:999px;font-size:13px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
button.primary{background:#f5f0ff;color:#161622;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
button.ghost{background:transparent;color:var(--soft);border:1px solid rgba(255,255,255,0.06)}
#favIcon{width:18px;height:18px;object-fit:contain;border-radius:6px}
.fav-gif-in{animation:favGifIn .26s ease both}
@keyframes favGifIn{from{opacity:0;transform:scale(.92)}to{opacity:1;transform:scale(1)}}
@keyframes foxWiggle{0%{transform:rotate(0) scale(1)}25%{transform:rotate(-6deg) scale(1.08)}50%{transform:rotate(4deg) scale(1.06)}75%{transform:rotate(-3deg) scale(1.05)}100%{transform:rotate(0) scale(1.06)}}
#favBtn.fav-active{color:#161622;background:linear-gradient(180deg,#fceeff,#f7d6ff);text-shadow:0 0 6px rgba(255,180,255,0.45),0 0 12px rgba(255,150,255,0.12);box-shadow:0 10px 26px rgba(180,120,255,0.14);animation:foxWiggle .45s ease-out;transform-origin:center center}
#playBtn{background:#f5f0ff;color:#161622;box-shadow:0 6px 18px rgba(0,0,0,0.06);padding-left:18px;padding-right:18px;border-radius:999px;border:none}
#playBtn.playing{background:linear-gradient(180deg,#fceeff,#f7d6ff);color:#161622;text-shadow:0 0 6px rgba(255,180,255,0.45),0 0 12px rgba(255,150,255,0.12);box-shadow:0 10px 26px rgba(180,120,255,0.14);animation:foxWiggle .45s ease-out;transform-origin:center center}
#playBtn:active,#favBtn:active{transform:scale(.99);transition:transform 80ms ease}
/* Door overlay + replay kept as-is (omitted for brevity) */
.replay{position:fixed;right:18px;bottom:18px;z-index:10010;background:rgba(255,255,255,0.04);color:var(--soft);border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:999px;font-size:13px;cursor:pointer}
.sparkle-pop{position:absolute;width:6px;height:6px;border-radius:50%;background:radial-gradient(circle,#ffffff 0%,#e7d4ff 60%,transparent 100%);opacity:0;animation:sparkleFade 1.2s ease-out forwards;pointer-events:none;filter:blur(.4px)}
@keyframes sparkleFade{0%{transform:translateY(0) scale(.5);opacity:0}15%{transform:translateY(-4px) scale(1);opacity:.95}50%{transform:translateY(-12px) scale(1.15);opacity:.8}100%{transform:translateY(-22px) scale(.7);opacity:0}}
/* NEWS modal styles - omitted for brevity */
.news-modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(5,4,8,0.6);z-index:10020;padding:20px}
.news-modal-backdrop.open{display:flex}
.news-modal{width:min(720px,calc(100% - 40px));max-height:80vh;overflow:auto;background:linear-gradient(180deg,rgba(12,10,14,0.96),rgba(16,14,20,0.98));border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(0,0,0,0.6);color:var(--text)}
/* ===========================
   iPod widget styles (new)
   classy, soft pastel that matches theme
   =========================== */
.ipod-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.5),rgba(0,0,0,0.7));z-index:10050;padding:20px}
.ipod-backdrop.open{display:flex}
.ipod{width:220px;max-width:92vw;border-radius:22px;padding:14px;background:linear-gradient(180deg,var(--ipod-cream),#fff);box-shadow:0 18px 60px var(--ipod-shadow);border:1px solid rgba(130,80,200,0.06);transform:translateY(20px);opacity:0;transition:all 320ms cubic-bezier(.2,.9,.2,1)}
.ipod.open{transform:none;opacity:1}
.ipod-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.ipod-title{font-weight:700;color:#2b1636;font-size:13px}
.ipod-close{background:transparent;border:0;color:#6b5473;font-weight:700;cursor:pointer}
.ipod-screen{height:120px;border-radius:12px;background:linear-gradient(180deg,rgba(120,80,180,0.06),rgba(90,50,140,0.04));display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px;position:relative;overflow:hidden}
.cover{width:86px;height:86px;border-radius:10px;background:linear-gradient(180deg,#f7e9ff,#efe1ff);box-shadow:inset 0 1px 0 rgba(255,255,255,0.6),0 6px 20px rgba(30,10,40,0.12);display:flex;align-items:center;justify-content:center;overflow:hidden}
.cover img{width:100%;height:100%;object-fit:cover}
.track-info{margin-left:12px;flex:1}
.track-title{font-weight:700;font-size:13px;color:#2b1636}
.track-artist{font-size:12px;color:#6b5473}
.ipod-controls{display:flex;align-items:center;gap:10px;margin-top:10px}
.ipod-play{background:linear-gradient(180deg,#fceeff,#f7d6ff);border-radius:999px;padding:8px 12px;border:none;font-weight:700;cursor:pointer;box-shadow:0 8px 20px rgba(120,50,160,0.12)}
.ipod-play.playing{animation:foxWiggle .45s ease-out}
.progress{width:100%;height:6px;background:rgba(0,0,0,0.06);border-radius:6px;overflow:hidden;margin-top:10px}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,#f7d6ff,#f5f0ff);transition:width 180ms linear}
.ipod-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:12px;color:#6b5473}
/* small animation to float the ipod slightly */
.ipod-float{animation:floaty 4s ease-in-out infinite}
@keyframes floaty{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
/* responsive tweaks */
@media (max-width:420px){.ipod{width:86vw;padding:12px}.ipod-screen{height:110px}}
</style>
</head>
<body>
  <!-- MAIN SHELL (kept from your file) -->
  <div class="shell" id="shell">
    <div class="card" id="card">

      <div class="title-row simple-one" role="banner">
        <h1 class="simple-name">Auroreine</h1>
      </div>

      <div class="tabs" id="tabs">
        <button class="tab small active" id="tab-zhou">‚ú¶ Muse</button>
        <button class="tab small" id="tab-rp">‚úß Another Universe</button>
        <button id="tab-news" class="tab" title="Latest news">üóûÔ∏è</button>
      </div>

      <div class="profile" id="profile">
        <h2 id="profile-title">Zhou Xinyu</h2>
        <small id="profile-tag">Muse ¬∑ TripleS</small>
        <p id="profile-text">Soft-spoken, stage-light kind of pretty.
Carries winter glow and slow-day calm,
like a quiet verse written in silver.</p>
      </div>

      <div class="btn-row">
        <button class="primary" id="favBtn" aria-pressed="false" title="Favorite">
          <img id="favIcon" alt="fox icon" src="foxfixfix.gif" aria-hidden="true">
          <span class="label-text">Favorite</span>
        </button>

        <button class="ghost" id="playBtn" aria-pressed="false" title="Play preview">‚ñ∂ Play</button>
      </div>

      <audio id="profileAudio" preload="auto">
        <source src="playsongnew.mp3" type="audio/mpeg">
      </audio>

      <div class="helper" style="margin-top:10px;font-size:10px;color:#8581a1;text-align:center;">Your choice will be sent back to the bot as a tiny note.</div>
    </div>
  </div>

  <button class="replay" id="replayBtn" title="Replay door effect">Replay ‚ú®</button>

  <!-- NEWS modal (kept) -->
  <div class="news-modal-backdrop" id="newsBackdrop" aria-hidden="true">
    <div class="news-modal" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
      <div class="news-header">
        <div style="display:flex;align-items:center;gap:12px;">
          <div>
            <div id="newsTitle" class="news-title-main">Recently update of Meredith Melrose.</div>
            <div class="news-sub" style="display:none;">Newest at top ‚Äî click to open a post</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="news-close" id="newsClose">Close</button>
          <a class="news-open-tele small-link" id="newsOpenChannel" target="_blank" rel="noopener noreferrer" href="https://t.me/S15XINYU">Open in Telegram</a>
        </div>
      </div>
      <div id="newsContent"><div class="news-empty" id="newsLoading">Loading latest posts‚Ä¶</div></div>
    </div>
  </div>

  <!-- iPod modal (NEW) -->
  <div class="ipod-backdrop" id="ipodBackdrop" aria-hidden="true">
    <div class="ipod ipod-float" id="ipod" role="dialog" aria-modal="true" aria-labelledby="ipodTitle">
      <div class="ipod-header">
        <div class="ipod-title" id="ipodTitle">Auroreine iPod</div>
        <button class="ipod-close" id="ipodClose" aria-label="Close">‚úï</button>
      </div>
      <div class="ipod-screen">
        <div style="display:flex;align-items:center;gap:12px;width:100%">
          <div class="cover"><img id="ipodCover" src="foxfixfix.gif" alt="cover"></div>
          <div style="flex:1;min-width:0">
            <div class="track-title" id="ipodTrackTitle">Playsong Preview</div>
            <div class="track-artist" id="ipodTrackArtist">‚Äî Auroreine</div>
            <div class="progress" aria-hidden="true"><div class="progress-bar" id="ipodProgress"></div></div>
          </div>
        </div>
        <div class="ipod-controls">
          <button class="ipod-play" id="ipodPlay">‚ñ∂ Play</button>
          <button class="ipod-prev" id="ipodPrev">‚óÄ‚óÄ</button>
          <button class="ipod-next" id="ipodNext">‚ñ∂‚ñ∂</button>
        </div>
        <div class="ipod-footer"><div id="ipodTime">0:00</div><div id="ipodDuration">0:00</div></div>
      </div>
    </div>
  </div>

<script>
// ========== Core from your file (trimmed where not needed) ==========
const shell = document.getElementById('shell');
const replayBtn = document.getElementById('replayBtn');
const tZ = document.getElementById('tab-zhou');
const tR = document.getElementById('tab-rp');
const tNews = document.getElementById('tab-news');
const profileAudio = document.getElementById('profileAudio');
const favBtn = document.getElementById('favBtn');
const playBtn = document.getElementById('playBtn');
const favIcon = document.getElementById('favIcon');

const ipodBackdrop = document.getElementById('ipodBackdrop');
const ipod = document.getElementById('ipod');
const ipodClose = document.getElementById('ipodClose');
const ipodPlay = document.getElementById('ipodPlay');
const ipodPrev = document.getElementById('ipodPrev');
const ipodNext = document.getElementById('ipodNext');
const ipodProgress = document.getElementById('ipodProgress');
const ipodTime = document.getElementById('ipodTime');
const ipodDuration = document.getElementById('ipodDuration');
const ipodCover = document.getElementById('ipodCover');
const ipodTrackTitle = document.getElementById('ipodTrackTitle');
const ipodTrackArtist = document.getElementById('ipodTrackArtist');

// profiles map
const profiles = {
  zhou: { title: "Zhou Xinyu", tag: "Muse ¬∑ TripleS", text: "Soft-spoken, stage-light kind of pretty.\nCarries winter glow and slow-day calm,\nlike a quiet verse written in silver.", audio: 'playsongnew.mp3', cover: 'foxfixfix.gif' },
  rp: { title: "Meredith Melrose", tag: "S15 ¬∑ night-coded", text: "Writes in lowercase and starlight.\nHalf diary, half song, always a little\nlate to leave the dream.", audio: 'playsongnew.mp3', cover: 'foxfixfix.gif' }
};
let selected = 'zhou';

// favorite triple-click logic
let favClickCount = 0;
let favClickTimer = null;
function resetFavClicks(){ favClickCount = 0; if (favClickTimer) { clearTimeout(favClickTimer); favClickTimer = null; } }

const STORAGE_KEY = 'miniapp_favs_v1';
function loadFavs(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {}; }catch(e){ return {}; } }
function saveFavs(obj){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); }catch(e){} }
function setFavState(isFav){ favBtn.setAttribute('aria-pressed', isFav ? 'true' : 'false'); const label = favBtn.querySelector('.label-text'); if (label) label.textContent = isFav ? 'Favorited' : 'Favorite'; try{ favIcon.src = profiles[selected].cover || 'foxfixfix.gif'; if (isFav) { favIcon.classList.add('fav-gif-in'); favBtn.classList.add('fav-active'); } else { favIcon.classList.remove('fav-gif-in'); favBtn.classList.remove('fav-active'); } }catch(e){ }
}
function initFavUIForCurrent(){ const favs = loadFavs(); const isFav = !!favs[selected]; favIcon.src = profiles[selected].cover || 'foxfixfix.gif'; setFavState(isFav); }

favBtn.addEventListener('click', ()=>{
  // normal favorite toggle behaviour (single click)
  const favs = loadFavs(); const currently = !!favs[selected];
  if (currently) delete favs[selected]; else favs[selected] = { ts: Date.now() };
  saveFavs(favs); setFavState(!currently);

  // send to telegram if available
  if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.sendData) {
    try { window.Telegram.WebApp.sendData(JSON.stringify({ type: 'fav', profile: selected, fav: !currently })); }catch(e){}
  }

  // --- triple-click detection: open ipod on 3 quick clicks ---
  favClickCount += 1;
  if (favClickTimer) { clearTimeout(favClickTimer); }
  favClickTimer = setTimeout(() => { resetFavClicks(); }, 900); // 900ms window to triple-click
  if (favClickCount >= 3) {
    resetFavClicks();
    openIPod();
  }
});

// audio play/pause handling (keeps profileAudio as source of truth)
const PROFILE_AUDIO_MAP = { zhou: 'playsongnew.mp3', rp: 'playsongnew.mp3' };
function currentProfileAudioFile(){ return PROFILE_AUDIO_MAP[selected] || 'playsongnew.mp3'; }

playBtn.addEventListener('click', async ()=>{
  if (!profileAudio) { alert('Audio not available. Tambahkan playsongnew.mp3 di folder yang sama dengan file ini.'); return; }
  const desired = currentProfileAudioFile();
  const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || '';
  if (currentSource !== desired) { profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`; try { profileAudio.load(); } catch(e){} }
  try{
    if (profileAudio.paused){ await profileAudio.play(); playBtn.classList.add('playing'); playBtn.textContent='‚è∏ Pause'; playBtn.setAttribute('aria-pressed','true'); }
    else { profileAudio.pause(); playBtn.classList.remove('playing'); playBtn.textContent='‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false'); }
  }catch(err){ playBtn.classList.remove('playing'); playBtn.textContent='‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false'); console.warn('Audio play error',err); alert('Gagal memutar audio ‚Äî coba tekan lagi atau periksa file audio (playsongnew.mp3).'); }
});

if (profileAudio){
  profileAudio.addEventListener('play', ()=>{ playBtn.classList.add('playing'); playBtn.textContent='‚è∏ Pause'; playBtn.setAttribute('aria-pressed','true'); ipodPlay.classList.add('playing'); ipodPlay.textContent='‚è∏ Pause'; });
  profileAudio.addEventListener('pause', ()=>{ playBtn.classList.remove('playing'); playBtn.textContent='‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false'); ipodPlay.classList.remove('playing'); ipodPlay.textContent='‚ñ∂ Play'; });
  profileAudio.addEventListener('ended', ()=>{ playBtn.classList.remove('playing'); playBtn.textContent='‚ñ∂ Play'; playBtn.setAttribute('aria-pressed','false'); ipodPlay.classList.remove('playing'); ipodPlay.textContent='‚ñ∂ Play'; try{ profileAudio.currentTime=0; }catch(e){} });
  profileAudio.addEventListener('timeupdate', ()=>{
    const cur = profileAudio.currentTime || 0; const dur = profileAudio.duration || 0;
    const pct = dur > 0 ? (cur/dur)*100 : 0; ipodProgress.style.width = pct + '%';
    ipodTime.textContent = formatTime(cur); ipodDuration.textContent = dur && !isNaN(dur) ? formatTime(dur) : '0:00';
  });
}

function formatTime(t){ if (!t || isNaN(t)) return '0:00'; const m = Math.floor(t/60); const s = Math.floor(t%60); return `${m}:${s<10? '0'+s : s}` }

// TAB switching
function setActive(k){ selected = k; const d = profiles[k]; document.getElementById('profile-title').textContent = d.title; document.getElementById('profile-tag').textContent = d.tag; document.getElementById('profile-text').textContent = d.text; [tZ,tR,tNews].forEach(el=> el.classList.remove('active')); if (k==='zhou') tZ.classList.add('active'); else if (k==='rp') tR.classList.add('active'); // switch audio source but keep play state
  if (!profileAudio) return; try{ const desired = profiles[selected].audio || 'playsongnew.mp3'; const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || ''; if (currentSource === desired) return; const wasPlaying = !profileAudio.paused && !profileAudio.ended; const currentTime = Math.max(0, Math.min(profileAudio.currentTime || 0, 999999)); profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`; try{ profileAudio.load(); }catch(e){} function tryRestore(){ try{ if (profileAudio.duration && !isNaN(profileAudio.duration)){ const t = Math.min(currentTime, Math.max(0, profileAudio.duration - 0.01)); profileAudio.currentTime = t; } else profileAudio.currentTime = currentTime; }catch(err){} if (wasPlaying) profileAudio.play().catch(()=>{}); profileAudio.removeEventListener('loadedmetadata', tryRestore);} if (profileAudio.readyState >= 1) tryRestore(); else profileAudio.addEventListener('loadedmetadata', tryRestore); }catch(err){ console.warn('Error while switching profile audio (non-fatal):', err); } initFavUIForCurrent(); }
if (tZ) tZ.addEventListener('click', ()=> { setActive('zhou'); });
if (tR) tR.addEventListener('click', ()=> { setActive('rp'); });

// ---------- iPod functions ----------
function openIPod(){
  // set ipod content from selected profile
  const p = profiles[selected] || profiles.zhou;
  ipodCover.src = p.cover || 'foxfixfix.gif';
  ipodTrackTitle.textContent = p.title || 'Preview';
  ipodTrackArtist.textContent = p.tag || '';
  // ensure audio source is the profile audio
  const desired = p.audio || 'playsongnew.mp3';
  const currentSource = profileAudio.querySelector('source')?.getAttribute('src') || '';
  if (currentSource !== desired){ profileAudio.innerHTML = `<source src="${desired}" type="audio/mpeg">`; try{ profileAudio.load(); }catch(e){} }
  ipodBackdrop.classList.add('open'); ipod.classList.add('open'); ipodBackdrop.setAttribute('aria-hidden','false');
}
function closeIPod(){ ipodBackdrop.classList.remove('open'); ipod.classList.remove('open'); ipodBackdrop.setAttribute('aria-hidden','true'); }

ipodClose.addEventListener('click', ()=>{ closeIPod(); });
ipodBackdrop.addEventListener('click', (ev)=>{ if (ev.target === ipodBackdrop) closeIPod(); });

// play/pause via ipod control (uses same profileAudio element)
ipodPlay.addEventListener('click', async ()=>{
  if (!profileAudio) return;
  try{
    if (profileAudio.paused){ await profileAudio.play(); ipodPlay.classList.add('playing'); ipodPlay.textContent='‚è∏ Pause'; }
    else { profileAudio.pause(); ipodPlay.classList.remove('playing'); ipodPlay.textContent='‚ñ∂ Play'; }
  }catch(e){ console.warn('ipod play err',e); }
});

// prev/next simple controls that seek +/- 10s
ipodPrev.addEventListener('click', ()=>{ if (!profileAudio) return; try{ profileAudio.currentTime = Math.max(0, (profileAudio.currentTime || 0) - 10); }catch(e){} });
ipodNext.addEventListener('click', ()=>{ if (!profileAudio) return; try{ profileAudio.currentTime = Math.min((profileAudio.duration||0), (profileAudio.currentTime || 0) + 10); }catch(e){} });

// keyboard ESC to close ipod
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape'){ if (ipodBackdrop.classList.contains('open')) closeIPod(); } });

// Init UI
setTimeout(()=>{ document.body.classList.add('loaded'); document.querySelector('.card')?.classList.add('visible'); },300);
initFavUIForCurrent();

</script>
</body>
</html>
