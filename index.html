<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Analog Cassette</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
/* === UI TIDAK DIUBAH, TAMBAH 1 CLASS SAJA === */
.song.now-playing{
  background:#ddd;
  font-weight:500;
}
</style>
</head>

<body>

<!-- === BODY & UI PERSIS SAMA (DISINGKAT DEMI PANJANG, JANGAN DIUBAH) === -->

<!-- â¬‡â¬‡â¬‡ COPY BODY + CSS DARI FILE TERAKHIR KAMU, LALU GANTI SCRIPT DI BAWAH INI â¬‡â¬‡â¬‡ -->

<iframe id="player" allow="autoplay" style="display:none"></iframe>

<script>
let ytPlayer
let isYTReady = false

function onYouTubeIframeAPIReady(){
  ytPlayer = new YT.Player('player',{
    events:{
      onStateChange:onPlayerStateChange
    }
  })
  isYTReady = true
}

function onPlayerStateChange(e){
  if(e.data === YT.PlayerState.ENDED){
    next()
  }
}

/* ===== DATA ===== */
let data = JSON.parse(localStorage.getItem("cassettePlaylists")) || [
  {name:"My Playlist",songs:[]}
]

let current={p:0,s:0},isPlaying=false,muted=false
let dragSong=null

const cassette=document.getElementById("cassette")
const playBtn=document.getElementById("playBtn")
const muteBtn=document.getElementById("muteBtn")

function save(){
  localStorage.setItem("cassettePlaylists",JSON.stringify(data))
}

function extractId(u){
  if(u.includes("youtu.be/")) return u.split("youtu.be/")[1].split("?")[0]
  return u.split("v=")[1]?.split("&")[0]
}

async function fetchTitle(url){
  try{
    const r=await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`)
    return (await r.json()).title
  }catch{return"Unknown Track"}
}

async function addSong(){
  const url=ytInput.value.trim()
  if(!url)return
  data[current.p].songs.push({url,title:await fetchTitle(url)})
  save();render();ytInput.value=""
}

/* ===== PLAY CONTROL ===== */
function play(p,s){
  current={p,s}
  startPlay()
}

function startPlay(){
  const song=data[current.p].songs[current.s]
  if(!song || !isYTReady) return

  ytPlayer.loadVideoById({
    videoId:extractId(song.url),
    suggestedQuality:"small"
  })

  if(muted) ytPlayer.mute()
  else ytPlayer.unMute()

  cassette.classList.add("playing")
  playBtn.textContent="â¸"
  isPlaying=true
  render()
}

function pause(){
  ytPlayer.pauseVideo()
  cassette.classList.remove("playing")
  playBtn.textContent="â–¶"
  isPlaying=false
}

function togglePlay(){
  isPlaying ? pause() : startPlay()
}

function toggleMute(){
  muted=!muted
  muteBtn.textContent=muted?"ðŸ”ˆ":"ðŸ”‡"
  if(muted) ytPlayer.mute()
  else ytPlayer.unMute()
}

function next(){
  const list=data[current.p].songs
  if(!list.length)return
  current.s=(current.s+1)%list.length
  startPlay()
}

function prev(){
  const list=data[current.p].songs
  if(!list.length)return
  current.s=(current.s-1+list.length)%list.length
  startPlay()
}

function shuffle(){
  const p=Math.floor(Math.random()*data.length)
  const s=Math.floor(Math.random()*data[p].songs.length)
  play(p,s)
}

/* ===== RENDER ===== */
function render(){
  playlists.innerHTML=""
  data.forEach((p,pi)=>{
    playlists.innerHTML+=`
      <div class="folder ${pi===current.p?'open':''}">
        <div class="folder-header">
          ${p.name}
        </div>
        <div class="songs">
          ${p.songs.map((s,si)=>`
            <div class="song ${pi===current.p && si===current.s?'now-playing':''}">
              <div class="song-title" onclick="play(${pi},${si})">${s.title}</div>
              <button class="song-delete"
                onclick="deleteSong(${pi},${si});event.stopPropagation()">âœ•</button>
            </div>
          `).join("")}
        </div>
      </div>`
  })
}

function deleteSong(p,s){
  data[p].songs.splice(s,1)
  save();render()
}

render()
</script>

</body>
</html>
