<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Profiles ‚Äî Auroreine</title>
<style>
/* (CSS omitted in this preview file to keep size reasonable in ZIP) */
/* Please replace with your full CSS from your original file. */
:root{--text:#f5f3ff;--soft:#b8b5d0}
body{background:#07060a;color:var(--text);font-family:system-ui,Segoe UI,Roboto;margin:0;padding:20px}
.card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;max-width:480px;margin:0 auto}
.news-modal-backdrop{position:fixed;inset:0;display:none}
.news-modal-backdrop.open{display:flex}
.news-modal{width:min(720px,calc(100% - 40px));background:#0c0a0e;padding:14px;border-radius:12px}
.news-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px}
.grid-thumb{width:100%;height:82px;object-fit:cover;border-radius:8px;background:#111}
</style>
</head>
<body>
  <div class="card">
    <h1>Auroreine</h1>
    <div class="tabs"><button id="tab-zhou">‚ú¶ Muse</button><button id="tab-rp">‚úß Another Universe</button><button id="tab-news">üóûÔ∏è</button></div>
    <div class="profile"><h2 id="profile-title">Zhou Xinyu</h2><small id="profile-tag">Muse ¬∑ TripleS</small>
    <p id="profile-text">Soft-spoken, stage-light kind of pretty.</p></div>
    <div class="btn-row"><button id="favBtn"><img id="favIcon" src="assets/foxfixfix.gif" width="18" height="18"> <span class="label-text">Favorite</span></button>
    <button id="playBtn">‚ñ∂ Play</button></div>
  </div>

  <div class="news-modal-backdrop" id="newsBackdrop" aria-hidden="true">
    <div class="news-modal" role="dialog" aria-modal="true" aria-labelledby="newsTitle">
      <div class="news-header">
        <div>
          <div id="newsTitle" style="font-weight:700;font-size:13px;">Recently update of Meredith Melrose.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button id="newsClose">Close</button>
          <a id="newsOpenChannel" class="news-open-tele small-link" target="_blank" rel="noopener noreferrer" href="https://t.me/S15XINYU">Open in Telegram</a>
        </div>
      </div>
      <div id="newsContent"><div class="news-empty">Loading latest posts‚Ä¶</div></div>
    </div>
  </div>

<script>
const NEWS_CHANNEL = 'S15XINYU';
const newsBackdrop = document.getElementById('newsBackdrop');
const newsContent = document.getElementById('newsContent');
const tNews = document.getElementById('tab-news');
const newsClose = document.getElementById('newsClose');
const newsOpenChannel = document.getElementById('newsOpenChannel');

function truncateText(s,n=140){if(!s)return'';s=s.replace(/\s+/g,' ').trim();if(s.length<=n)return s;return s.slice(0,n-1).trim()+'‚Ä¶';}
function renderFallbackThumbnails(posts){
  newsContent.innerHTML='';
  const grid=document.createElement('div');grid.className='news-grid';
  if(!posts||posts.length===0){newsContent.innerHTML='<div class="news-empty">Unable to fetch previews. Try "Open in Telegram".</div>'; const openBtn=document.createElement('a'); openBtn.className='news-open-tele'; openBtn.textContent='Open channel in Telegram'; openBtn.href='https://t.me/'+NEWS_CHANNEL; openBtn.target='_blank'; openBtn.rel='noopener noreferrer'; newsContent.appendChild(openBtn); return;}
  posts.forEach(p=>{ const item=document.createElement('div'); item.className='grid-item'; const a=document.createElement('a'); a.href=p.link||('https://t.me/'+NEWS_CHANNEL); a.target='_blank'; a.rel='noopener noreferrer'; const img=document.createElement('img'); img.className='grid-thumb'; img.alt=p.timeStr||'post'; if(p.thumb) img.src=p.thumb; else img.src=''; a.appendChild(img); const t=document.createElement('div'); t.className='news-title'; t.style.fontSize='12px'; t.style.margin='0'; t.style.color='var(--soft)'; t.textContent=truncateText(p.excerpt||p.timeStr||'',80); item.appendChild(a); item.appendChild(t); grid.appendChild(item); });
  newsContent.appendChild(grid);
}
function renderNewsList(posts){
  if(!posts||posts.length===0){newsContent.innerHTML='<div class="news-empty">No recent posts were found.</div>'; return;}
  const list=document.createElement('div'); list.className='news-list';
  posts.forEach(post=>{ const item=document.createElement('div'); item.className='news-item'; const thumb=document.createElement('img'); thumb.className='news-thumb'; thumb.alt='thumb'; thumb.loading='lazy'; if(post.thumb) thumb.src=post.thumb; else { thumb.style.background='#111'; thumb.src=''; } const meta=document.createElement('div'); meta.className='news-meta'; const title=document.createElement('div'); title.className='news-title'; title.textContent=post.timeStr||NEWS_CHANNEL; const excerpt=document.createElement('p'); excerpt.className='news-excerpt'; excerpt.textContent=truncateText(post.excerpt||post.text||'',140); const actions=document.createElement('div'); actions.className='news-actions'; const btnOpen=document.createElement('a'); btnOpen.className='news-open-tele'; btnOpen.textContent='Open in Telegram'; btnOpen.href=post.link||('https://t.me/'+NEWS_CHANNEL); btnOpen.target='_blank'; btnOpen.rel='noopener noreferrer'; actions.appendChild(btnOpen); meta.appendChild(title); meta.appendChild(excerpt); meta.appendChild(actions); item.appendChild(thumb); item.appendChild(meta); list.appendChild(item); });
  newsContent.innerHTML=''; newsContent.appendChild(list);
}

function renderFallbackIframe(){ newsContent.innerHTML=''; const iframe=document.createElement('iframe'); iframe.className='news-fallback-iframe'; iframe.src='https://t.me/s/'+NEWS_CHANNEL; iframe.loading='lazy'; iframe.referrerPolicy='no-referrer'; newsContent.appendChild(iframe); }

async function loadNewsParsed(maxPosts=8){
  newsContent.innerHTML='<div class="news-empty">Loading latest posts‚Ä¶</div>';
  const apiUrl = `/api/tme?channel=${encodeURIComponent(NEWS_CHANNEL)}&max=${maxPosts}`;
  try{
    const r = await fetch(apiUrl, { method:'GET' });
    if(!r.ok) throw new Error('API returned ' + r.status);
    const payload = await r.json();
    if(payload && payload.ok && Array.isArray(payload.posts) && payload.posts.length>0){
      const haveThumbs = payload.posts.some(p=>p.thumb);
      if(haveThumbs) renderFallbackThumbnails(payload.posts); else renderNewsList(payload.posts);
      return;
    }
    renderFallbackIframe();
  }catch(err){
    console.warn('loadNewsParsed failed; falling back to iframe/proxy', err);
    try{
      const proxyUrl = `https://r.jina.ai/http://t.me/s/${NEWS_CHANNEL}`;
      const pr = await fetch(proxyUrl, { method:'GET' });
      if(pr.ok){
        const txt = await pr.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(txt,'text/html');
        const msgs = Array.from(doc.querySelectorAll('.tgme_widget_message, .tgme_widget_message_wrap, .tme_widget_message'));
        const posts = [];
        for(let i=0;i<msgs.length && posts.length<maxPosts;i++){
          const m = msgs[i];
          const textNode = m.querySelector('.tgme_widget_message_text') || m.querySelector('.message_text') || m.querySelector('p') || m;
          let excerpt=''; if(textNode) excerpt=(textNode.textContent||textNode.innerText||'').trim();
          let thumb=null;
          const photo = m.querySelector('.tgme_widget_message_photo') || m.querySelector('img');
          if(photo){
            const img = photo.querySelector ? photo.querySelector('img') : null;
            if(img && (img.getAttribute('src')||img.getAttribute('data-src'))) thumb = img.getAttribute('src')||img.getAttribute('data-src');
            else if(photo.style && photo.style.backgroundImage){ const bg=photo.style.backgroundImage; const match=bg.match(/url\(["']?(.*?)["']?\)/); if(match) thumb=match[1]; }
            else if(photo.getAttribute && (photo.getAttribute('src')||photo.getAttribute('data-src'))) thumb = photo.getAttribute('src')||photo.getAttribute('data-src');
          }
          let link=null; const a = m.querySelector('a.tgme_widget_message_date') || m.querySelector('a[href*="/' + NEWS_CHANNEL + '/"]') || m.querySelector('a');
          if(a && a.href) link = a.href;
          let timeStr=''; const timeNode = m.querySelector('.tgme_widget_message_date')||m.querySelector('time');
          if(timeNode) timeStr = timeNode.textContent || timeNode.getAttribute('datetime') || '';
          posts.push({ excerpt, thumb, link, timeStr });
        }
        if(posts.length>0){ const haveThumbs = posts.some(p=>p.thumb); if(haveThumbs) renderFallbackThumbnails(posts); else renderNewsList(posts); return; }
      }
    }catch(e){}
    renderFallbackIframe();
  }
}

tNews.addEventListener('click', ()=>{ newsBackdrop.classList.add('open'); newsBackdrop.setAttribute('aria-hidden','false'); loadNewsParsed(8); });
newsClose.addEventListener('click', ()=>{ newsBackdrop.classList.remove('open'); newsBackdrop.setAttribute('aria-hidden','true'); const iframe = newsContent.querySelector('iframe'); if(iframe) iframe.src='about:blank'; });
newsBackdrop.addEventListener('click', (ev)=>{ if(ev.target===newsBackdrop) { newsBackdrop.classList.remove('open'); newsBackdrop.setAttribute('aria-hidden','true'); } });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && newsBackdrop.classList.contains('open')) { newsBackdrop.classList.remove('open'); newsBackdrop.setAttribute('aria-hidden','true'); } });
</script>
</body>
</html>
